<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-body-bg: #121212;
            --bs-body-color: #e0e0e0;
            --bs-emphasis-color: #fff;
            --bs-secondary-bg: #1e1e1e;
            --bs-tertiary-bg: #2a2a2a;
            --bs-primary: #3b82f6;
            --bs-border-color: #3a3a3a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            -webkit-tap-highlight-color: transparent;
        }

        .main-container {
            padding-bottom: 70px;
        }

        .app-header {
            background-color: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--bs-border-color);
        }

        .profile-quick-info {
            cursor: pointer;
        }

        .profile-pic-sm {
            width: 35px;
            height: 35px;
            object-fit: cover;
            border-radius: 50%;
        }

        .role-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 5px;
            background-color: var(--bs-primary);
            color: white;
            margin-left: 5px;
        }

        /* Mobile App Style Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--bs-border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item-bottom {
            flex-grow: 1;
            text-align: center;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item-bottom.active {
            color: var(--bs-primary);
        }
        .nav-item-bottom .bi {
            font-size: 1.5rem;
        }
        .nav-item-bottom span {
            display: block;
            font-size: 0.7rem;
        }

        /* Content Pages */
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tournament Card */
        .tournament-card {
            background-color: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease-in-out;
        }
        .tournament-card:hover {
            transform: translateY(-5px);
        }
        .tournament-poster {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .card-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        .status-open { background-color: rgba(20, 184, 166, 0.8); }
        .status-full { background-color: rgba(244, 63, 94, 0.8); }
        .status-closed { background-color: rgba(107, 114, 128, 0.8); }
        
        .winner-banner {
            background: linear-gradient(45deg, #fceabb, #f8b500);
            color: #333;
            font-weight: bold;
        }

        /* Post Section */
        .post-card {
            background-color: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
        }
        .post-author-pic {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        .post-image {
            max-height: 400px;
            width: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .comment-input {
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
        }
        .comment {
            background-color: var(--bs-tertiary-bg);
            padding: 8px 12px;
            border-radius: 10px;
        }

        /* Banned Screen */
        #ban-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
            flex-direction: column;
            padding: 20px;
        }
        
        /* Search Modal */
        #search-results {
            max-height: 70vh;
            overflow-y: auto;
        }
        .search-result-item {
            border-bottom: 1px solid var(--bs-border-color);
        }
        .search-result-item:last-child {
            border-bottom: none;
        }

        /* General UI */
        .form-control, .form-select {
            background-color: var(--bs-tertiary-bg);
            border-color: var(--bs-border-color);
            color: var(--bs-body-color);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bs-tertiary-bg);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
            color: var(--bs-body-color);
        }
        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .modal-content {
            background-color: var(--bs-secondary-bg);
        }

        .announcement-popup {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideInUp 0.5s forwards;
        }
        @keyframes slideInUp {
            from { bottom: -100%; }
            to { bottom: 70px; }
        }
        .announcement-popup.dismissed {
            animation: slideOutDown 0.5s forwards;
        }
        @keyframes slideOutDown {
            from { bottom: 70px; opacity: 1; }
            to { bottom: -100%; opacity: 0; }
        }
        
        .loader {
          width: 50px;
          aspect-ratio: 1;
          border-radius: 50%;
          border: 8px solid #555;
          border-right-color: var(--bs-primary);
          animation: l2 1s infinite linear;
          margin: 20px auto;
        }
        @keyframes l2 {to{transform: rotate(1turn)}}
    </style>
</head>
<body>

    <div id="ban-overlay" class="d-none">
        <div>
            <h1 class="display-1"><i class="bi bi-slash-circle"></i></h1>
            <h2 class="mt-4">You Are Banned</h2>
            <p class="lead">Please contact the support team for more information.</p>
        </div>
    </div>
    
    <div id="auth-page" class="container vh-100 d-flex justify-content-center align-items-center">
        <div class="w-100" style="max-width: 400px;">
            <div class="text-center mb-4">
                <h1 class="h2 fw-bold">Tournament Hub</h1>
                <p class="text-muted">Join the battle!</p>
            </div>
            
            <div id="login-form-container">
                <form id="login-form">
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="login-email" placeholder="name@example.com" required>
                        <label for="login-email">Email address</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="login-password" placeholder="Password" required>
                        <label for="login-password">Password</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 btn-lg">Login</button>
                </form>
                <div class="text-center my-3">
                    <a href="#" id="show-register-form" class="text-decoration-none">Don't have an account? Register</a><br>
                    <a href="#" id="forgot-password" class="text-decoration-none small">Forgot Password?</a>
                </div>
            </div>

            <div id="register-form-container" class="d-none">
                <form id="register-form">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="register-name" placeholder="Full Name" required>
                        <label for="register-name">Full Name</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="register-ff-id" placeholder="FF ID" required>
                        <label for="register-ff-id">FF ID</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="register-email" placeholder="name@example.com" required>
                        <label for="register-email">Email address</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="register-password" placeholder="Password" required>
                        <label for="register-password">Password</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 btn-lg">Register</button>
                </form>
                <div class="text-center my-3">
                    <a href="#" id="show-login-form" class="text-decoration-none">Already have an account? Login</a>
                </div>
            </div>

            <div class="text-center">
                <p class="text-muted small my-2">OR</p>
                <button id="guest-login-btn" class="btn btn-secondary w-100">Continue as Guest</button>
            </div>
        </div>
    </div>
    
    <div id="app-content" class="d-none">
        
        <header class="app-header sticky-top p-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0">Tournament Hub</h5>
                <div class="d-flex align-items-center">
                    <i class="bi bi-search fs-4 me-3" data-bs-toggle="modal" data-bs-target="#searchModal"></i>
                    <div id="profile-quick-info" class="d-flex align-items-center profile-quick-info">
                        <img id="header-profile-pic" src="https://i.ibb.co/61Ysncn/default-avatar.png" class="profile-pic-sm me-2">
                        <div>
                            <div class="fw-bold" id="header-user-name">Guest</div>
                            <div class="small text-muted" id="header-wallet-balance">Balance: ৳0</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-container container mt-3">
            <div id="home-page" class="page active">
                <div id="main-banner-container"></div>
                <h4 class="mt-3">Upcoming Tournaments</h4>
                <div id="tournaments-list" class="row g-3">
                    <div class="text-center py-5">
                        <div class="loader"></div>
                        <p>Loading Tournaments...</p>
                    </div>
                </div>
            </div>

            <div id="posts-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Community Posts</h4>
                    <button id="create-post-btn" class="btn btn-sm btn-primary d-none"><i class="bi bi-plus-lg"></i> Create Post</button>
                </div>
                <div id="posts-feed" class="d-flex flex-column gap-3">
                    <div class="text-center py-5">
                        <div class="loader"></div>
                        <p>Loading Posts...</p>
                    </div>
                </div>
            </div>

            <div id="wallet-page" class="page">
                <h4>My Wallet</h4>
                <div class="card tournament-card p-4 text-center mb-4">
                    <h6 class="text-muted">CURRENT BALANCE</h6>
                    <h1 class="display-4 fw-bold" id="wallet-main-balance">৳0</h1>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#depositModal"><i class="bi bi-arrow-down-circle-fill"></i> Deposit</button>
                        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#withdrawModal"><i class="bi bi-arrow-up-circle-fill"></i> Withdraw</button>
                    </div>
                </div>
                <h5>Transaction History</h5>
                <div id="transaction-history" class="list-group">
                    </div>
            </div>
            
            <div id="profile-page" class="page">
                 <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                        <img id="profile-main-pic" src="https://i.ibb.co/61Ysncn/default-avatar.png" class="rounded-circle" width="120" height="120" style="object-fit: cover; border: 3px solid var(--bs-primary);">
                        <label for="profile-pic-upload" class="position-absolute bottom-0 end-0 bg-primary rounded-circle p-2" style="cursor:pointer;">
                           <i class="bi bi-camera-fill text-white"></i>
                        </label>
                        <input type="file" id="profile-pic-upload" class="d-none" accept="image/*">
                    </div>
                    <h3 class="mt-3 mb-0" id="profile-user-name">User Name</h3>
                    <p class="text-muted mb-1" id="profile-ff-id">FF ID: 12345</p>
                    <span id="profile-role-badge"></span>
                </div>
                
                <div class="row text-center g-2 mb-4">
                    <div class="col">
                        <div class="p-3 tournament-card">
                            <h6 class="text-muted small">Wallet</h6>
                            <h5 class="fw-bold" id="profile-wallet-balance">৳0</h5>
                        </div>
                    </div>
                     <div class="col">
                        <div class="p-3 tournament-card">
                            <h6 class="text-muted small">Income</h6>
                            <h5 class="fw-bold" id="profile-income">৳0</h5>
                        </div>
                    </div>
                </div>

                <h5>Joined Tournaments</h5>
                <div id="joined-tournaments-history" class="list-group mb-4">
                    </div>

                <h5>Match History</h5>
                 <div id="match-history-table" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr><th>Tournament</th><th>Result</th><th>Kills</th><th>Date</th></tr>
                        </thead>
                        <tbody id="match-history-body">
                            </tbody>
                    </table>
                </div>
                <hr>
                <div class="d-grid">
                    <button class="btn btn-outline-danger" id="logout-btn"><i class="bi bi-box-arrow-right"></i> Logout</button>
                </div>
            </div>
            
            <div id="more-page" class="page">
                <h4>More Options</h4>
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#rulesModal"><i class="bi bi-journal-text me-2"></i> Rules / Guidelines</a>
                    <a href="#" id="support-chat-link" class="list-group-item list-group-item-action"><i class="bi bi-chat-dots-fill me-2"></i> Support Chat</a>
                    <a href="#" class="list-group-item list-group-item-action disabled"><i class="bi bi-trophy-fill me-2"></i> Leaderboard (Coming Soon)</a>
                    <a href="#" class="list-group-item list-group-item-action text-danger" id="logout-btn-more"><i class="bi bi-box-arrow-right me-2"></i> Logout</a>
                </div>
            </div>

        </main>
        
        <nav class="bottom-nav">
            <div class="nav-item-bottom active" data-page="home-page">
                <i class="bi bi-house-fill"></i>
                <span>Home</span>
            </div>
            <div class="nav-item-bottom" data-page="posts-page">
                <i class="bi bi-file-post-fill"></i>
                <span>Posts</span>
            </div>
            <div class="nav-item-bottom" data-page="wallet-page">
                <i class="bi bi-wallet-fill"></i>
                <span>Wallet</span>
            </div>
             <div class="nav-item-bottom" data-page="profile-page">
                <i class="bi bi-person-fill"></i>
                <span>Profile</span>
            </div>
            <div class="nav-item-bottom" data-page="more-page">
                <i class="bi bi-three-dots"></i>
                <span>More</span>
            </div>
        </nav>
        
        <div id="announcement-container"></div>
    </div>
    
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <div class="input-group">
                       <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                       <input type="text" id="search-input" class="form-control border-start-0" placeholder="Search Players, Tournaments, Posts...">
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="search-results">
                    <p class="text-center text-muted">Start typing to see results</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="depositModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Deposit Funds</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Send money to the number below (min 10 BDT):</p>
            <div class="alert alert-info">
              <strong>bKash / Rocket / Nagad:</strong> <code>01767882562</code> (Send Money)
            </div>
            <form id="deposit-form">
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select id="deposit-method" class="form-select" required>
                        <option value="bKash">bKash</option>
                        <option value="Rocket">Rocket</option>
                        <option value="Nagad">Nagad</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount (BDT)</label>
                    <input type="number" id="deposit-amount" class="form-control" min="10" placeholder="e.g., 50" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Your Phone Number</label>
                    <input type="text" id="deposit-phone" class="form-control" placeholder="Number you sent from" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Transaction ID</label>
                    <input type="text" id="deposit-trx-id" class="form-control" placeholder="Enter TrxID here" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Deposit Request</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="withdrawModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Withdraw Funds</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Minimum withdrawal is 50 BDT. Payouts are processed by an admin.</p>
            <form id="withdraw-form">
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select id="withdraw-method" class="form-select" required>
                        <option value="bKash">bKash</option>
                        <option value="Rocket">Rocket</option>
                        <option value="Nagad">Nagad</option>
                    </select>
                </div>
                 <div class="mb-3">
                    <label class="form-label">Amount (BDT)</label>
                    <input type="number" id="withdraw-amount" class="form-control" min="50" placeholder="e.g., 100" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Your Account Number</label>
                    <input type="text" id="withdraw-account" class="form-control" placeholder="Number to receive money" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Withdraw Request</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="rulesModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rules & Guidelines</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h6>General Rules</h6>
            <p>1. Hacking or use of third-party software is strictly prohibited.</p>
            <p>2. Teaming with opponents is not allowed in solo matches.</p>
            <p>3. Be respectful to all players, moderators, and admins.</p>
            <p>4. Admins have the final say in all disputes.</p>
            <h6>Payment Rules</h6>
            <p>1. Ensure you enter the correct Transaction ID for deposits.</p>
            <p>2. Withdrawals are processed within 24 hours.</p>
            <p>3. Do not spam withdrawal requests.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="createPostModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-post-form">
                        <div class="mb-3">
                            <label class="form-label">Post Title</label>
                            <input type="text" id="post-title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea id="post-content" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image (Optional)</label>
                            <input type="file" id="post-image-upload" class="form-control" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Publish Post</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="supportChatModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="height: 70vh;">
                <div class="modal-header">
                    <h5 class="modal-title">Support Chat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div id="chat-messages" class="modal-body d-flex flex-column-reverse" style="overflow-y: auto;">
                    </div>
                <div class="modal-footer">
                    <form id="chat-form" class="w-100 d-flex gap-2">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." required>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body">
                This is a toast message.
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhSjh1VxQFrzslIwOZ1yOxLYuNT2Le_sg",
            authDomain: "fram-and-go.firebaseapp.com",
            databaseURL: "https://fram-and-go-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fram-and-go",
            storageBucket: "fram-and-go.firebasestorage.app",
            messagingSenderId: "781295119002",
            appId: "1:781295119002:web:3d84890a0bb85e5d1c0d23",
            measurementId: "G-H30RNBNE6X"
        };
        
        // ImgBB API Key
        const IMGBB_API_KEY = "a5e9f23952de30236c940c60b740ec9d";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase();

        // Global state
        let currentUser = null;
        let currentUserData = null;
        let allUsers = {};
        let allTournaments = {};
        let allPosts = {};

        // --- UI ELEMENTS ---
        const authPage = document.getElementById('auth-page');
        const appContent = document.getElementById('app-content');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const banOverlay = document.getElementById('ban-overlay');

        // --- UTILS ---
        const appToast = new bootstrap.Toast(document.getElementById('appToast'));
        const showToast = (title, message, type = 'info') => {
            const toastTitle = document.getElementById('toast-title');
            const toastBody = document.getElementById('toast-body');
            const toastEl = document.getElementById('appToast');
            
            toastEl.classList.remove('bg-success', 'bg-danger', 'bg-info');
            if (type === 'success') toastEl.classList.add('bg-success', 'text-white');
            if (type === 'danger') toastEl.classList.add('bg-danger', 'text-white');
            if (type === 'info') toastEl.classList.add('bg-info', 'text-white');

            toastTitle.textContent = title;
            toastBody.textContent = message;
            appToast.show();
        };

        const uploadImage = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error(result.error.message);
                }
            } catch (error) {
                console.error("Image upload failed:", error);
                showToast("Error", "Failed to upload image.", 'danger');
                return null;
            }
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authPage.classList.add('d-none');
                appContent.classList.remove('d-none');
                listenToUserData();
                initializeAppData();
            } else {
                currentUser = null;
                currentUserData = null;
                authPage.classList.remove('d-none');
                appContent.classList.add('d-none');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => showToast("Login Failed", error.message, 'danger'));
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const ffId = document.getElementById('register-ff-id').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    set(ref(db, 'users/' + user.uid), {
                        name: name,
                        email: email,
                        ffId: ffId,
                        role: 'player',
                        profilePic: 'https://i.ibb.co/61Ysncn/default-avatar.png',
                        wallet: 0,
                        income: 0,
                        banStatus: false,
                        joinHistory: {}
                    });
                })
                .catch(error => showToast("Registration Failed", error.message, 'danger'));
        });
        
        document.getElementById('guest-login-btn').addEventListener('click', () => {
             signInAnonymously(auth).catch(error => showToast("Guest Login Failed", error.message, 'danger'));
        });
        
        document.getElementById('forgot-password').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => showToast("Success", "Password reset email sent!", 'success'))
                    .catch(error => showToast("Error", error.message, 'danger'));
            }
        });

        document.getElementById('show-register-form').addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('d-none');
            registerFormContainer.classList.remove('d-none');
        });

        document.getElementById('show-login-form').addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.classList.add('d-none');
            loginFormContainer.classList.remove('d-none');
        });

        // --- DATA LISTENERS ---
        function listenToUserData() {
            if (!currentUser) return;
            if (currentUser.isAnonymous) {
                // Handle guest user data
                currentUserData = {
                    name: 'Guest',
                    role: 'player',
                    wallet: 0,
                    income: 0,
                    profilePic: 'https://i.ibb.co/61Ysncn/default-avatar.png',
                    banStatus: false,
                };
                updateUI();
                return;
            }
            const userRef = ref(db, 'users/' + currentUser.uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentUserData = data;
                    if (data.banStatus) {
                        banOverlay.classList.remove('d-none');
                    } else {
                        banOverlay.classList.add('d-none');
                    }
                    updateUI();
                }
            });
        }
        
        function initializeAppData() {
            // Listen to all users
            onValue(ref(db, 'users'), snapshot => {
                allUsers = snapshot.val() || {};
            });
            // Listen to tournaments
            onValue(ref(db, 'tournaments'), snapshot => {
                allTournaments = snapshot.val() || {};
                renderTournaments();
            });
            // Listen to posts
            onValue(ref(db, 'posts'), snapshot => {
                allPosts = snapshot.val() || {};
                renderPosts();
            });
            // Listen to banners
            onValue(ref(db, 'banners'), snapshot => {
                const banners = snapshot.val() || {};
                renderBanners(banners);
            });
            // Listen to transactions
            onValue(ref(db, 'transactions'), snapshot => {
                const transactions = snapshot.val() || {};
                renderTransactions(transactions);
            });
            // Listen to match history
            if (currentUser && !currentUser.isAnonymous) {
                onValue(ref(db, `matchHistory/${currentUser.uid}`), snapshot => {
                    const history = snapshot.val() || {};
                    renderMatchHistory(history);
                });
            }
        }
        
        // --- UI RENDERING ---
        function updateUI() {
            if (!currentUserData) return;
            // Header
            document.getElementById('header-profile-pic').src = currentUserData.profilePic;
            document.getElementById('header-user-name').textContent = currentUserData.name;
            document.getElementById('header-wallet-balance').textContent = `Balance: ৳${currentUserData.wallet || 0}`;
            
            // Profile Page
            document.getElementById('profile-main-pic').src = currentUserData.profilePic;
            document.getElementById('profile-user-name').textContent = currentUserData.name;
            document.getElementById('profile-ff-id').textContent = `FF ID: ${currentUserData.ffId || 'N/A'}`;
            let roleBadgeHTML = '';
            if (currentUserData.role === 'moderator') {
                roleBadgeHTML = `<span class="role-badge">🛡️ Moderator</span>`;
                document.getElementById('create-post-btn').classList.remove('d-none');
            } else {
                 document.getElementById('create-post-btn').classList.add('d-none');
            }
            document.getElementById('profile-role-badge').innerHTML = roleBadgeHTML;
            document.getElementById('profile-wallet-balance').textContent = `৳${currentUserData.wallet || 0}`;
            document.getElementById('profile-income').textContent = `৳${currentUserData.income || 0}`;

            // Wallet Page
            document.getElementById('wallet-main-balance').textContent = `৳${currentUserData.wallet || 0}`;
            
            // Joined Tournaments History
            renderJoinedTournaments();
        }
        
        function renderTournaments() {
            const container = document.getElementById('tournaments-list');
            container.innerHTML = '';
            const tournaments = Object.entries(allTournaments).sort(([,a],[,b]) => (b.timestamp || 0) - (a.timestamp || 0));

            if (tournaments.length === 0) {
                container.innerHTML = '<p class="text-center text-muted col-12">No upcoming tournaments right now.</p>';
                return;
            }

            tournaments.forEach(([id, t]) => {
                const isJoined = currentUserData?.joinHistory && currentUserData.joinHistory[id];
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="tournament-card">
                        <div class="position-relative">
                            <img src="${t.poster || 'https://via.placeholder.com/400x200'}" class="tournament-poster" alt="${t.name}">
                            <span class="card-status status-${t.status?.toLowerCase() || 'open'}">${t.status || 'Open'}</span>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${t.name}</h5>
                            <div class="d-flex justify-content-between text-muted small mb-2">
                                <span><i class="bi bi-tag-fill"></i> ${t.type}</span>
                                <span><i class="bi bi-calendar-event-fill"></i> ${new Date(t.date).toLocaleDateString()}</span>
                            </div>
                            <p class="mb-2"><strong>Prize:</strong> ${t.prizePool}</p>
                            <p class="mb-2"><strong>Entry Fee:</strong> ${t.entryFee > 0 ? `৳${t.entryFee}` : 'Free'}</p>
                            ${t.winner ? `
                                <div class="winner-banner p-2 rounded text-center mb-2">
                                    👑 Winner: ${t.winner.name}
                                </div>
                            ` : `
                                <div class="d-grid">
                                    <button class="btn btn-sm ${isJoined ? 'btn-secondary disabled' : 'btn-primary'} join-tournament-btn" 
                                            data-id="${id}" data-fee="${t.entryFee}" ${isJoined ? 'disabled' : ''}>
                                        ${isJoined ? 'Joined' : 'Join Now'}
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function renderPosts() {
            const feed = document.getElementById('posts-feed');
            feed.innerHTML = '';
            const posts = Object.entries(allPosts).sort(([, a], [, b]) => b.timestamp - a.timestamp);

            if (posts.length === 0) {
                feed.innerHTML = '<p class="text-center text-muted col-12">No posts yet. Be the first!</p>';
                return;
            }

            posts.forEach(([postId, post]) => {
                const author = allUsers[post.authorUid] || { name: 'Unknown', profilePic: 'https://i.ibb.co/61Ysncn/default-avatar.png' };
                const isLiked = currentUser && post.likes && post.likes[currentUser.uid];
                const likesCount = post.likes ? Object.keys(post.likes).length : 0;
                
                const postCard = document.createElement('div');
                postCard.className = 'post-card p-3';
                postCard.innerHTML = `
                    <div class="d-flex align-items-center mb-3">
                        <img src="${author.profilePic}" class="post-author-pic me-3">
                        <div>
                            <h6 class="mb-0">${author.name} ${post.authorRole === 'moderator' ? '🛡️' : ''}</h6>
                            <small class="text-muted">${new Date(post.timestamp).toLocaleString()}</small>
                        </div>
                    </div>
                    <h5>${post.title}</h5>
                    <p>${post.content}</p>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image mb-3">` : ''}
                    <div class="d-flex gap-3 align-items-center border-top border-bottom py-2 my-2">
                       <button class="btn btn-link text-decoration-none p-0 like-btn ${isLiked ? 'text-primary' : 'text-muted'}" data-post-id="${postId}">
                            <i class="bi ${isLiked ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-up'}"></i> Like (${likesCount})
                        </button>
                        <button class="btn btn-link text-decoration-none p-0 text-muted" data-bs-toggle="collapse" data-bs-target="#comments-${postId}">
                            <i class="bi bi-chat-dots"></i> Comment
                        </button>
                    </div>
                    <div class="collapse" id="comments-${postId}">
                        <div class="comments-section mt-2" data-post-id="${postId}">
                            </div>
                        <form class="d-flex gap-2 mt-2 comment-form" data-post-id="${postId}">
                            <input type="text" class="form-control form-control-sm comment-input" placeholder="Write a comment..." required>
                            <button type="submit" class="btn btn-sm btn-primary">Post</button>
                        </form>
                    </div>
                `;
                feed.appendChild(postCard);
                renderComments(postId, post.comments || {});
            });
        }
        
        function renderComments(postId, comments) {
            const container = document.querySelector(`.comments-section[data-post-id="${postId}"]`);
            container.innerHTML = '';
            Object.values(comments).sort((a,b) => a.timestamp - b.timestamp).forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment mb-2';
                commentDiv.innerHTML = `
                    <strong class="small">${comment.authorName}</strong>
                    <p class="mb-0 small">${comment.text}</p>
                `;
                container.appendChild(commentDiv);
            });
        }

        function renderBanners(banners) {
            // Main Banner
            if (banners.mainBanner) {
                document.getElementById('main-banner-container').innerHTML = `
                    <img src="${banners.mainBanner}" class="img-fluid rounded mb-3" alt="Tournament Banner">
                `;
            }
            // Announcement Banner
            if (banners.announcement && banners.announcement.active && !sessionStorage.getItem('announcementDismissed')) {
                const announcementContainer = document.getElementById('announcement-container');
                announcementContainer.innerHTML = `
                    <div class="card announcement-popup" id="announcement-popup">
                        <div class="card-body p-2">
                             <button type="button" class="btn-close position-absolute top-0 end-0 p-2" id="dismiss-announcement"></button>
                             <img src="${banners.announcement.imageUrl}" class="img-fluid rounded">
                        </div>
                    </div>
                `;
                document.getElementById('dismiss-announcement').addEventListener('click', () => {
                    const popup = document.getElementById('announcement-popup');
                    popup.classList.add('dismissed');
                    sessionStorage.setItem('announcementDismissed', 'true');
                });
            }
        }

        function renderTransactions(allTransactions) {
            const container = document.getElementById('transaction-history');
            container.innerHTML = '';
            if (!currentUser || currentUser.isAnonymous) {
                 container.innerHTML = '<p class="text-muted text-center">Login to see transactions.</p>';
                 return;
            }
            
            const userTransactions = Object.values(allTransactions)
                .filter(tx => tx.uid === currentUser.uid)
                .sort((a,b) => b.timestamp - a.timestamp);
                
            if (userTransactions.length === 0) {
                 container.innerHTML = '<p class="text-muted text-center">No transactions yet.</p>';
                 return;
            }
            
            userTransactions.forEach(tx => {
                let statusBadge;
                if (tx.status === 'pending') statusBadge = 'bg-warning text-dark';
                else if (tx.status === 'approved') statusBadge = 'bg-success';
                else if (tx.status === 'rejected') statusBadge = 'bg-danger';

                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <h6 class="mb-0 text-capitalize">${tx.type}: ${tx.method}</h6>
                        <small class="text-muted">${new Date(tx.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="text-end">
                       <strong class="${tx.type === 'deposit' ? 'text-success' : 'text-warning'}">
                            ${tx.type === 'deposit' ? '+' : '-'}৳${tx.amount}
                       </strong><br>
                       <span class="badge ${statusBadge}">${tx.status}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function renderJoinedTournaments() {
            const container = document.getElementById('joined-tournaments-history');
            container.innerHTML = '';
            if (!currentUserData || !currentUserData.joinHistory) {
                container.innerHTML = '<p class="text-muted">You haven\'t joined any tournaments yet.</p>';
                return;
            }
            Object.keys(currentUserData.joinHistory).forEach(tourneyId => {
                const t = allTournaments[tourneyId];
                if (t) {
                    const item = document.createElement('a');
                    item.href = "#";
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `<strong>${t.name}</strong> - ${new Date(t.date).toLocaleDateString()}`;
                    container.appendChild(item);
                }
            });
        }

        function renderMatchHistory(history) {
             const tbody = document.getElementById('match-history-body');
             tbody.innerHTML = '';
             if (Object.keys(history).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No match history found.</td></tr>';
                return;
             }
             Object.values(history).forEach(match => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${match.tournamentName}</td>
                    <td>${match.result}</td>
                    <td>${match.kills}</td>
                    <td>${new Date(match.date).toLocaleDateString()}</td>
                `;
                tbody.appendChild(row);
             });
        }

        function renderSearchResults(query) {
             const resultsContainer = document.getElementById('search-results');
             resultsContainer.innerHTML = '';
             query = query.toLowerCase();

             if (query.length < 2) {
                 resultsContainer.innerHTML = '<p class="text-center text-muted">Start typing to see results</p>';
                 return;
             }
             
             let resultsFound = false;

             // Search Tournaments
             Object.entries(allTournaments).forEach(([id, t]) => {
                 if (t.name.toLowerCase().includes(query)) {
                     resultsFound = true;
                     const item = document.createElement('div');
                     item.className = 'p-3 search-result-item';
                     item.innerHTML = `
                        <div class="fw-bold"><i class="bi bi-trophy-fill text-warning me-2"></i> ${t.name}</div>
                        <div class="small text-muted">Tournament - ${t.type}</div>
                     `;
                     resultsContainer.appendChild(item);
                 }
             });

             // Search Posts
             Object.entries(allPosts).forEach(([id, p]) => {
                 if (p.title.toLowerCase().includes(query) || p.content.toLowerCase().includes(query)) {
                     resultsFound = true;
                     const item = document.createElement('div');
                     item.className = 'p-3 search-result-item';
                     item.innerHTML = `
                        <div class="fw-bold"><i class="bi bi-file-post-fill text-info me-2"></i> ${p.title}</div>
                        <div class="small text-muted">Post by ${allUsers[p.authorUid]?.name || 'Unknown'}</div>
                     `;
                     resultsContainer.appendChild(item);
                 }
             });

             // Search Players
             Object.entries(allUsers).forEach(([id, u]) => {
                 if (u.role !== 'moderator' && (u.name.toLowerCase().includes(query) || u.ffId.toLowerCase().includes(query))) {
                     resultsFound = true;
                     const item = document.createElement('div');
                     item.className = 'p-3 search-result-item';
                     item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${u.profilePic}" class="profile-pic-sm me-2">
                            <div>
                                <div class="fw-bold"><i class="bi bi-person-fill text-success me-2"></i> ${u.name}</div>
                                <div class="small text-muted">Player - FF ID: ${u.ffId}</div>
                            </div>
                        </div>
                     `;
                     resultsContainer.appendChild(item);
                 }
             });

             if (!resultsFound) {
                 resultsContainer.innerHTML = '<p class="text-center text-muted">No results found.</p>';
             }
        }

        
        // --- EVENT LISTENERS ---
        // Logout
        [document.getElementById('logout-btn'), document.getElementById('logout-btn-more')].forEach(btn => {
            btn.addEventListener('click', () => signOut(auth));
        });

        // Navigation
        document.querySelector('.bottom-nav').addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item-bottom');
            if (!navItem) return;
            
            document.querySelectorAll('.nav-item-bottom').forEach(item => item.classList.remove('active'));
            navItem.classList.add('active');

            const pageId = navItem.dataset.page;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        });
        document.getElementById('profile-quick-info').addEventListener('click', () => {
             document.querySelector('.nav-item-bottom[data-page="profile-page"]').click();
        });
        
        // Join Tournament
        document.getElementById('tournaments-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('join-tournament-btn')) {
                if (currentUser.isAnonymous) {
                    showToast("Access Denied", "Please register or log in to join tournaments.", "danger");
                    return;
                }
                const btn = e.target;
                const tourneyId = btn.dataset.id;
                const fee = parseInt(btn.dataset.fee);

                if (currentUserData.wallet < fee) {
                    showToast("Error", "Insufficient wallet balance.", "danger");
                    return;
                }
                
                if (confirm(`Join this tournament for ৳${fee}? This amount will be deducted from your wallet.`)) {
                    const newBalance = currentUserData.wallet - fee;
                    const updates = {};
                    updates[`/users/${currentUser.uid}/wallet`] = newBalance;
                    updates[`/users/${currentUser.uid}/joinHistory/${tourneyId}`] = true;
                    updates[`/tournaments/${tourneyId}/joinedPlayers/${currentUser.uid}`] = {
                        name: currentUserData.name,
                        ffId: currentUserData.ffId,
                    };
                    update(ref(db), updates)
                        .then(() => showToast("Success", "Successfully joined the tournament!", "success"))
                        .catch(err => showToast("Error", err.message, "danger"));
                }
            }
        });

        // Profile Picture Upload
        document.getElementById('profile-pic-upload').addEventListener('change', async (e) => {
             if (currentUser.isAnonymous) return;
             const file = e.target.files[0];
             if (file) {
                 showToast("Uploading", "Your new profile picture is being uploaded...", 'info');
                 const imageUrl = await uploadImage(file);
                 if (imageUrl) {
                    await set(ref(db, `users/${currentUser.uid}/profilePic`), imageUrl);
                    showToast("Success", "Profile picture updated!", "success");
                 }
             }
        });
        
        // Deposit/Withdraw Forms
        document.getElementById('deposit-form').addEventListener('submit', e => {
            e.preventDefault();
            if (currentUser.isAnonymous) { showToast("Error", "Please login to deposit.", "danger"); return; }
            
            const newTxRef = push(ref(db, 'transactions'));
            set(newTxRef, {
                uid: currentUser.uid,
                type: 'deposit',
                method: document.getElementById('deposit-method').value,
                amount: parseInt(document.getElementById('deposit-amount').value),
                phone: document.getElementById('deposit-phone').value,
                transactionId: document.getElementById('deposit-trx-id').value,
                status: 'pending',
                timestamp: serverTimestamp()
            }).then(() => {
                showToast("Success", "Deposit request submitted.", 'success');
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
                e.target.reset();
            }).catch(err => showToast("Error", err.message, 'danger'));
        });
        
        document.getElementById('withdraw-form').addEventListener('submit', e => {
            e.preventDefault();
            if (currentUser.isAnonymous) { showToast("Error", "Please login to withdraw.", "danger"); return; }
            
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (amount > currentUserData.wallet) {
                showToast("Error", "Withdrawal amount exceeds balance.", 'danger');
                return;
            }

            const newTxRef = push(ref(db, 'transactions'));
            set(newTxRef, {
                uid: currentUser.uid,
                type: 'withdraw',
                method: document.getElementById('withdraw-method').value,
                amount: amount,
                account: document.getElementById('withdraw-account').value,
                status: 'pending',
                timestamp: serverTimestamp()
            }).then(() => {
                showToast("Success", "Withdraw request submitted.", 'success');
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                e.target.reset();
            }).catch(err => showToast("Error", err.message, 'danger'));
        });

        // Search
        document.getElementById('search-input').addEventListener('keyup', (e) => {
            renderSearchResults(e.target.value);
        });

        // Post Interactions
        document.getElementById('create-post-btn').addEventListener('click', () => {
            new bootstrap.Modal(document.getElementById('createPostModal')).show();
        });
        
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const imageFile = document.getElementById('post-image-upload').files[0];
            
            showToast("Posting...", "Your post is being created.", "info");
            
            let imageUrl = null;
            if (imageFile) {
                imageUrl = await uploadImage(imageFile);
            }
            
            const newPostRef = push(ref(db, 'posts'));
            set(newPostRef, {
                authorUid: currentUser.uid,
                authorName: currentUserData.name,
                authorRole: currentUserData.role,
                title,
                content,
                imageUrl,
                timestamp: serverTimestamp(),
                likes: {},
                comments: {}
            }).then(() => {
                showToast("Success", "Post created!", "success");
                bootstrap.Modal.getInstance(document.getElementById('createPostModal')).hide();
                e.target.reset();
            }).catch(err => showToast("Error", err.message, 'danger'));
        });

        document.getElementById('posts-feed').addEventListener('click', e => {
            const likeBtn = e.target.closest('.like-btn');
            if (likeBtn) {
                if(currentUser.isAnonymous) { showToast("Error", "Please login to like posts.", "danger"); return; }
                const postId = likeBtn.dataset.postId;
                const likeRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
                get(likeRef).then(snapshot => {
                    if (snapshot.exists()) {
                        remove(likeRef); // Unlike
                    } else {
                        set(likeRef, true); // Like
                    }
                });
            }
        });

        document.getElementById('posts-feed').addEventListener('submit', e => {
            if (e.target.classList.contains('comment-form')) {
                e.preventDefault();
                if(currentUser.isAnonymous) { showToast("Error", "Please login to comment.", "danger"); return; }
                
                const postId = e.target.dataset.postId;
                const input = e.target.querySelector('input');
                const text = input.value.trim();
                
                if (text) {
                    const newCommentRef = push(ref(db, `posts/${postId}/comments`));
                    set(newCommentRef, {
                        authorUid: currentUser.uid,
                        authorName: currentUserData.name,
                        text: text,
                        timestamp: serverTimestamp()
                    });
                    input.value = '';
                }
            }
        });

        // Support Chat
        document.getElementById('support-chat-link').addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser.isAnonymous) { showToast("Error", "Please login to use support chat.", "danger"); return; }
            const chatModal = new bootstrap.Modal(document.getElementById('supportChatModal'));
            chatModal.show();
            
            const chatMessagesRef = ref(db, `supportChats/${currentUser.uid}/messages`);
            onValue(chatMessagesRef, (snapshot) => {
                const messages = snapshot.val() || {};
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.innerHTML = ''; // Clear existing messages
                const sortedMessages = Object.values(messages).sort((a,b) => a.timestamp - b.timestamp);
                
                // We render from bottom to top due to flex-column-reverse
                sortedMessages.reverse().forEach(msg => {
                    const isUser = msg.sender === currentUser.uid;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `p-2 my-1 rounded w-75 ${isUser ? 'ms-auto bg-primary' : 'me-auto bg-secondary'}`;
                    msgDiv.innerHTML = `<div class="small">${msg.text}</div>`;
                    chatContainer.appendChild(msgDiv);
                });
            });
        });

        document.getElementById('chat-form').addEventListener('submit', e => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                const newMsgRef = push(ref(db, `supportChats/${currentUser.uid}/messages`));
                set(newMsgRef, {
                    sender: currentUser.uid,
                    text: text,
                    timestamp: serverTimestamp()
                });
                update(ref(db, `supportChats/${currentUser.uid}`), { isReadByAdmin: false });
                input.value = '';
            }
        });

    </script>
</body>
</html>
