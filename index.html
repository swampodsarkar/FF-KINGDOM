<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FF Kingdom - Mobile App</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #facc15;
  --primary-dark: #e6b800;
  --dark: #0f172a;
  --dark-light: #1e293b;
  --text: #f8fafc;
  --text-secondary: #cbd5e1;
  --success: #22c55e;
  --danger: #ef4444;
  --info: #3b82f6;
  --warning: #f59e0b;
  --royal: #a855f7;
  --organizer: #10b981;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--dark);
  color: var(--text);
  padding-bottom: 60px;
}

.header {
  background: var(--dark-light);
  color: var(--primary);
  padding: 15px;
  text-align: center;
  font-weight: 700;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header h1 {
  margin: 0;
  font-size: 1.5rem;
}

.search-container {
  position: relative;
  width: 100%;
  margin: 10px 0;
}

.search-input {
  width: 100%;
  padding: 12px 40px 12px 12px;
  border-radius: 25px;
  border: 1px solid #334155;
  background: var(--dark);
  color: var(--text);
  font-family: 'Poppins', sans-serif;
}

.search-icon {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
}

.container {
  padding: 16px;
}

.card {
  background: var(--dark-light);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: none;
}

.input-group {
  margin-bottom: 12px;
}

.input-group label {
  display: block;
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.input-group input, .input-group select, .input-group textarea {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: var(--dark);
  color: var(--text);
  font-family: 'Poppins', sans-serif;
}

.btn {
  background: var(--primary);
  color: var(--dark);
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn i {
  margin-right: 5px;
}

.btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 14px;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-info {
  background: var(--info);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-royal {
  background: var(--royal);
  color: white;
}

.btn-organizer {
  background: var(--organizer);
  color: white;
}

.hidden {
  display: none;
}

.nav-bottom {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background: var(--dark-light);
  padding: 10px 0;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  z-index: 100;
}

.nav-btn {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 0;
}

.nav-btn i {
  font-size: 18px;
  margin-bottom: 4px;
}

.nav-btn.active {
  color: var(--primary);
}

.countdown {
  color: var(--primary);
  font-weight: 700;
}

.tournament-card {
  transition: transform 0.3s;
  margin-bottom: 20px;
  overflow: hidden;
  position: relative;
}

.tournament-card:hover {
  transform: translateY(-5px);
}

.tournament-img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 8px;
}

.tournament-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--primary);
  color: var(--dark);
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.tournament-content {
  padding: 12px;
}

.tournament-title {
  color: var(--primary);
  margin: 4px 0;
  font-size: 18px;
  font-weight: 600;
}

.tournament-info {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 2px 0;
  display: flex;
  align-items: center;
  gap: 5px;
}

.tournament-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.tournament-actions button {
  flex: 1;
}

.game-mode-badges {
  display: flex;
  gap: 5px;
  margin: 8px 0;
  flex-wrap: wrap;
}

.game-mode-badge {
  background: rgba(168, 85, 247, 0.2);
  color: var(--royal);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}

.profile-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.profile-pic {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary);
}

.profile-info {
  margin-left: 15px;
}

.profile-name {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.stat-card {
  background: var(--dark);
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}

.stat-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.emoji-picker {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin: 10px 0;
  max-height: 100px;
  overflow-y: auto;
  padding: 5px;
  background: var(--dark);
  border-radius: 8px;
}

.emoji-option {
  font-size: 24px;
  cursor: pointer;
  padding: 5px;
  border-radius: 5px;
  transition: background 0.2s;
}

.emoji-option:hover {
  background: rgba(255, 255, 255, 0.1);
}

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: var(--dark-light);
  padding: 20px;
  border-radius: 12px;
  max-width: 90%;
  max-height: 80%;
  overflow-y: auto;
  color: var(--text);
  width: 400px;
}

.modal-title {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 15px;
}

.form-section {
  margin-bottom: 20px;
}

.form-section-title {
  color: var(--primary);
  font-size: 16px;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid #334155;
}

.tournament-details {
  line-height: 1.6;
}

.tournament-details strong {
  color: var(--primary);
}

.loading {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
}

.wallet-section {
  margin: 15px 0;
}

.transaction-list {
  max-height: 200px;
  overflow-y: auto;
}

.transaction-item {
  padding: 10px;
  border-bottom: 1px solid #334155;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.transaction-item:last-child {
  border-bottom: none;
}

.status-pending {
  color: #f59e0b;
}

.status-approved {
  color: var(--success);
}

.status-rejected {
  color: var(--danger);
}

.registration-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid #334155;
}

.tab-btn {
  padding: 10px 15px;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-weight: 500;
  cursor: pointer;
}

.tab-btn.active {
  color: var(--primary);
  border-bottom: 2px solid var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.text-small {
  font-size: 12px;
  color: var(--text-secondary);
}

.currency-badge {
  background: var(--primary);
  color: var(--dark);
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 12px;
}

.player-name {
  color: var(--primary);
  font-weight: 500;
}

.player-list {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
}

.player-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid #334155;
}

.player-item:last-child {
  border-bottom: none;
}

.player-uid {
  font-size: 12px;
  color: var(--text-secondary);
}

.uploading {
  opacity: 0.7;
  pointer-events: none;
}

.progress-bar {
  height: 5px;
  background: #334155;
  border-radius: 10px;
  margin-top: 5px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--primary);
  width: 0%;
  transition: width 0.3s;
}

.announcement-item {
  padding: 12px;
  border-bottom: 1px solid #334155;
}

.announcement-item:last-child {
  border-bottom: none;
}

.announcement-title {
  color: var(--primary);
  font-weight: 600;
  margin-bottom: 5px;
}

.announcement-date {
  font-size: 12px;
  color: var(--text-secondary);
}

.filter-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  overflow-x: auto;
  padding-bottom: 5px;
}

.filter-btn {
  background: var(--dark);
  color: var(--text-secondary);
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
}

.filter-btn.active {
  background: var(--primary);
  color: var(--dark);
}

.user-search-result {
  display: flex;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid #334155;
  cursor: pointer;
}

.user-search-result:last-child {
  border-bottom: none;
}

.user-search-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 12px;
  border: 2px solid var(--primary);
}

.user-search-info {
  flex: 1;
}

.user-search-name {
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 4px;
}

.user-search-uid {
  font-size: 12px;
  color: var(--text-secondary);
}

.banned-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: var(--danger);
  z-index: 10;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.banned-icon {
  font-size: 40px;
  margin-bottom: 10px;
}

.search-results-container {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--dark-light);
  border-radius: 0 0 12px 12px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  display: none;
}

.search-results-container.active {
  display: block;
}

.verified-badge {
  color: var(--info);
  margin-left: 5px;
}

.organizer-section {
  border-left: 3px solid var(--organizer);
  padding-left: 10px;
  margin: 20px 0;
}

.organizer-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.winner-selection {
  background: rgba(16, 185, 129, 0.1);
  border-radius: 8px;
  padding: 10px;
  margin-top: 10px;
}

.winner-list {
  max-height: 150px;
  overflow-y: auto;
  margin-top: 10px;
}

.winner-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid rgba(16, 185, 129, 0.2);
}

.winner-item:last-child {
  border-bottom: none;
}

.winner-selected {
  background: rgba(16, 185, 129, 0.2);
}

.organizer-tournament-card {
  border: 1px solid var(--organizer);
}

.organizer-tournament-card .tournament-title {
  color: var(--organizer);
}

.tournament-winner-badge {
  background: var(--organizer);
  color: white;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 10px;
}

.organizer-name {
  color: var(--organizer);
  font-weight: 600;
  margin-top: 5px;
  font-size: 14px;
}

.tournament-date {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 2px 0;
}

/* New styles for improved mobile UI */
.tournament-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 15px;
}

@media (min-width: 480px) {
  .tournament-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 768px) {
  .tournament-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

.tournament-card-mobile {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.tournament-img-mobile {
  height: 140px;
  object-fit: cover;
  border-radius: 8px 8px 0 0;
}

.tournament-content-mobile {
  flex: 1;
  padding: 12px;
}

.organizer-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.announcement-toast {
  position: fixed;
  top: 70px;
  right: 15px;
  background: var(--dark-light);
  border-left: 4px solid var(--primary);
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  display: flex;
  align-items: center;
  max-width: 320px;
  transform: translateX(400px);
  transition: transform 0.3s ease;
}

.announcement-toast.show {
  transform: translateX(0);
}

.announcement-toast-icon {
  font-size: 24px;
  margin-right: 10px;
  color: var(--primary);
}

.announcement-toast-content {
  flex: 1;
}

.announcement-toast-title {
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--primary);
}

.announcement-toast-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 16px;
  margin-left: 10px;
}

/* Improved form styling */
.form-control {
  background: var(--dark);
  border: 1px solid #334155;
  color: var(--text);
  border-radius: 8px;
  padding: 12px;
  width: 100%;
  font-family: 'Poppins', sans-serif;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
}

/* Improved button styling */
.btn-block {
  width: 100%;
}

/* Improved tournament card layout for mobile */
.tournament-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  font-size: 12px;
}

.tournament-prize {
  color: var(--primary);
  font-weight: 600;
}

.tournament-slots {
  color: var(--text-secondary);
}

/* New styles for announcements slider */
.announcements-slider {
  position: fixed;
  top: 60px;
  left: 0;
  right: 0;
  background: var(--dark-light);
  border-bottom: 1px solid #334155;
  z-index: 99;
  overflow: hidden;
  height: 40px;
}

.announcements-track {
  display: flex;
  animation: slideAnnouncements 30s linear infinite;
  white-space: nowrap;
}

.announcement-slide {
  padding: 10px 20px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.announcement-slide i {
  margin-right: 10px;
  color: var(--primary);
}

@keyframes slideAnnouncements {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}

/* New styles for social section */
.social-section {
  margin-top: 20px;
}

.social-button {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  background: var(--dark);
  border-radius: 8px;
  margin-bottom: 10px;
  text-decoration: none;
  color: var(--text);
  transition: background 0.3s;
}

.social-button:hover {
  background: var(--dark-light);
}

.social-icon {
  width: 30px;
  text-align: center;
  margin-right: 10px;
}

.social-content {
  flex: 1;
}

.social-title {
  font-weight: 600;
  margin-bottom: 2px;
}

.social-description {
  font-size: 12px;
  color: var(--text-secondary);
}

.social-action {
  color: var(--primary);
  font-weight: 600;
}

/* New styles for referral system */
.referral-section {
  background: rgba(34, 197, 94, 0.1);
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.referral-code {
  background: white;
  color: var(--dark);
  padding: 10px;
  border-radius: 8px;
  font-family: monospace;
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  margin: 10px 0;
  letter-spacing: 2px;
}

.copy-btn {
  background: var(--success);
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  width: 100%;
}

/* New styles for tournament editing */
.edit-tournament-form {
  max-height: 70vh;
  overflow-y: auto;
}

/* New styles for announcement banners */
.announcement-banner {
  background: linear-gradient(90deg, var(--primary-dark), var(--primary));
  color: var(--dark);
  padding: 10px 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.announcement-banner i {
  margin-right: 10px;
}

.announcement-banner-close {
  background: none;
  border: none;
  color: var(--dark);
  cursor: pointer;
  font-size: 16px;
}
</style>
</head>
<body>

<!-- Announcements Slider -->
<div class="announcements-slider" id="announcementsSlider">
  <div class="announcements-track" id="announcementsTrack">
    <!-- Announcements will be loaded here -->
  </div>
</div>

<!-- Login/Registration Page -->
<div id="authPage" class="container">
  <div class="card">
    <h2 class="text-center mb-4">üëë FF Kingdom</h2>
    
    <div class="registration-tabs">
      <button class="tab-btn active" id="loginTabBtn">Login</button>
      <button class="tab-btn" id="registerTabBtn">Player Register</button>
      <button class="tab-btn" id="organizerRegisterTabBtn">Organizer Register</button>
    </div>
    
    <div class="tab-content active" id="loginTab">
      <div class="input-group">
        <label for="loginEmail">üìß Email</label>
        <input id="loginEmail" type="email" placeholder="Your email"/>
      </div>
      <div class="input-group">
        <label for="loginPassword">üîí Password</label>
        <input id="loginPassword" type="password" placeholder="Password"/>
      </div>
      <button id="loginBtn" class="btn w-100"><i class="fas fa-sign-in-alt"></i> Login</button>
    </div>
    
    <div class="tab-content" id="registerTab">
      <div class="input-group">
        <label for="regName">üë§ Full Name</label>
        <input id="regName" type="text" placeholder="Your full name"/>
      </div>
      <div class="input-group">
        <label for="regEmail">üìß Email</label>
        <input id="regEmail" type="email" placeholder="Your email"/>
      </div>
      <div class="input-group">
        <label for="regMobile">üì± Mobile Number</label>
        <input id="regMobile" type="tel" placeholder="Your mobile number"/>
      </div>
      <div class="input-group">
        <label for="regFFUID">üéÆ Free Fire UID</label>
        <input id="regFFUID" type="text" placeholder="Your Free Fire UID"/>
      </div>
      <div class="input-group">
        <label for="regPassword">üîí Password</label>
        <input id="regPassword" type="password" placeholder="Create password"/>
      </div>
      <div class="input-group">
        <label for="regConfirmPassword">üîí Confirm Password</label>
        <input id="regConfirmPassword" type="password" placeholder="Confirm your password"/>
      </div>
      <button id="signUpBtn" class="btn w-100"><i class="fas fa-user-plus"></i> Create Player Account</button>
    </div>
    
    <div class="tab-content" id="organizerRegisterTab">
      <div class="input-group">
        <label for="orgRegName">üë§ Organizer Name</label>
        <input id="orgRegName" type="text" placeholder="Organizer name"/>
      </div>
      <div class="input-group">
        <label for="orgRegEmail">üìß Email</label>
        <input id="orgRegEmail" type="email" placeholder="Your email"/>
      </div>
      <div class="input-group">
        <label for="orgRegPassword">üîí Password</label>
        <input id="orgRegPassword" type="password" placeholder="Create password"/>
      </div>
      <div class="input-group">
        <label for="orgRegConfirmPassword">üîí Confirm Password</label>
        <input id="orgRegConfirmPassword" type="password" placeholder="Confirm your password"/>
      </div>
      <button id="orgSignUpBtn" class="btn btn-organizer w-100"><i class="fas fa-user-plus"></i> Create Organizer Account</button>
    </div>
  </div>
</div>

<!-- Main App Pages -->
<div id="appPages" class="hidden">
  <div class="header">
    <h1>üî• FF Kingdom</h1>
    <button id="searchToggleBtn" class="btn btn-sm"><i class="fas fa-search"></i></button>
  </div>

  <!-- Search Container (initially hidden) -->
  <div id="searchContainer" class="container hidden">
    <div class="search-container">
      <input type="text" id="userSearchInput" class="search-input" placeholder="Search players by name or UID...">
      <i class="fas fa-search search-icon"></i>
      <div id="searchResults" class="search-results-container"></div>
    </div>
  </div>

  <div id="homePage" class="container">
    <h3 class="mb-3">üî• Ongoing Tournaments</h3>
    
    <!-- Announcement Banner -->
    <div class="announcement-banner hidden" id="homeAnnouncementBanner">
      <div><i class="fas fa-bullhorn"></i> <span id="bannerText"></span></div>
      <button class="announcement-banner-close" id="bannerClose"><i class="fas fa-times"></i></button>
    </div>
    
    <!-- Game Mode Filters -->
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="battle-royale">Battle Royale</button>
      <button class="filter-btn" data-filter="clash-squad">Clash Squad</button>
      <button class="filter-btn" data-filter="leon-wolf">Lone Wolf</button>
    </div>
    
    <div id="tournamentsList" class="loading tournament-grid">
      <i class="fas fa-spinner fa-spin"></i> Loading tournaments...
    </div>
  </div>

  <div id="profilePage" class="container hidden">
    <div class="card">
      <div class="profile-header">
        <img id="profilePic" src="https://via.placeholder.com/80" class="profile-pic" alt="Profile"/>
        <div class="profile-info">
          <h2 class="profile-name" id="profileName">Player Name</h2>
          <p id="profileFFUID">üéÆ Free Fire UID: <span>Not set</span></p>
          <p id="profileStatusDisplay" class="text-small">üí¨ Status: No status set</p>
        </div>
      </div>
      
      <div class="profile-stats" id="playerStats">
        <div class="stat-card">
          <div class="stat-value" id="walletBalance">0</div>
          <div class="stat-label">üí∞ BDT</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileMatches">0</div>
          <div class="stat-label">üéÆ Matches</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileWins">0</div>
          <div class="stat-label">üèÜ Wins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="profileIncome">0</div>
          <div class="stat-label">üíµ Income</div>
        </div>
      </div>
      
      <div class="organizer-stats hidden" id="organizerStats">
        <div class="stat-card">
          <div class="stat-value" id="tournamentsHosted">0</div>
          <div class="stat-label">üèÜ Tournaments Hosted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="tournamentsCompleted">0</div>
          <div class="stat-label">‚úÖ Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalParticipants">0</div>
          <div class="stat-label">üë• Participants</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="organizerIncome">0</div>
          <div class="stat-label">üíµ Income</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="form-section-title"><i class="fas fa-user-edit"></i> Edit Profile</h3>
      
      <div class="input-group">
        <label for="editName">üë§ Display Name</label>
        <input id="editName" type="text" placeholder="Your display name"/>
      </div>
      
      <div class="input-group">
        <label for="editFFUID">üéÆ Free Fire UID</label>
        <input id="editFFUID" type="text" placeholder="Your Free Fire UID"/>
      </div>
      
      <div class="input-group">
        <label for="profileStatus">üí¨ Status</label>
        <textarea id="profileStatus" placeholder="What's on your mind?" rows="2"></textarea>
      </div>
      
      <div class="input-group">
        <label>üòä Select Emoji for Profile</label>
        <div class="emoji-picker">
          <span class="emoji-option">üòä</span>
          <span class="emoji-option">üòé</span>
          <span class="emoji-option">ü•≥</span>
          <span class="emoji-option">üéÆ</span>
          <span class="emoji-option">üî•</span>
          <span class="emoji-option">üëë</span>
          <span class="emoji-option">üí™</span>
          <span class="emoji-option">‚ö°</span>
          <span class="emoji-option">‚≠ê</span>
          <span class="emoji-option">üéØ</span>
        </div>
      </div>
      
      <div class="input-group">
        <label for="profilePicFile">üñºÔ∏è Profile Picture</label>
        <input id="profilePicFile" type="file" accept="image/*"/>
        <div class="progress-bar">
          <div class="progress-fill" id="uploadProgress"></div>
        </div>
      </div>
      
      <button id="updateProfileBtn" class="btn w-100"><i class="fas fa-save"></i> Update Profile</button>
      <button id="uploadPicBtn" class="btn btn-info w-100 mt-2"><i class="fas fa-upload"></i> Upload Picture</button>
    </div>

    <div class="card" id="playerWalletSection">
      <h3 class="form-section-title"><i class="fas fa-wallet"></i> Wallet</h3>
      
      <div class="wallet-section">
        <h4><i class="fas fa-money-bill-wave"></i> Deposit (min 10)</h4>
        <p>Send <b>01767882562</b> ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶ö‡ßá Transaction ID ‡¶¶‡¶ø‡¶®</p>
        
        <div class="input-group">
          <label for="depositAmount">üí∞ Amount</label>
          <input id="depositAmount" type="number" placeholder="Amount" min="10"/>
        </div>
        
        <div class="input-group">
          <label for="depositTransactionId">üìã Transaction ID</label>
          <input id="depositTransactionId" type="text" placeholder="Transaction ID"/>
        </div>
        
        <div class="input-group">
          <label for="depositMethod">üí≥ Payment Method</label>
          <select id="depositMethod">
            <option>üì± bKash</option>
            <option>üì± Nagad</option>
            <option>üì± Rocket</option>
          </select>
        </div>
        
        <button id="depositBtn" class="btn w-100"><i class="fas fa-plus-circle"></i> Deposit</button>
      </div>
      
      <div class="wallet-section">
        <h4><i class="fas fa-hand-holding-usd"></i> Withdraw (min 100)</h4>
        
        <div class="input-group">
          <label for="withdrawAmount">üí∞ Amount</label>
          <input id="withdrawAmount" type="number" placeholder="Amount" min="100"/>
        </div>
        
        <div class="input-group">
          <label for="withdrawAccount">üìã Account Number</label>
          <input id="withdrawAccount" type="text" placeholder="Account Number"/>
        </div>
        
        <div class="input-group">
          <label for="withdrawMethod">üí≥ Payment Method</label>
          <select id="withdrawMethod">
            <option>üì± bKash</option>
            <option>üì± Nagad</option>
            <option>üì± Rocket</option>
          </select>
        </div>
        
        <button id="withdrawBtn" class="btn w-100"><i class="fas fa-download"></i> Withdraw</button>
      </div>
    </div>

    <div class="card">
      <h3 class="form-section-title"><i class="fas fa-history"></i> Transaction History</h3>
      <div id="transactionsList" class="transaction-list">
        <div class="text-center py-3">No records found</div>
      </div>
    </div>
  </div>

  <div id="myTournamentsPage" class="container hidden">
    <h3 class="mb-3"><i class="fas fa-trophy"></i> My Tournaments</h3>
    <div class="card">
      <div id="myTournamentsList" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading your tournaments...
      </div>
    </div>
  </div>

  <div id="organizerPage" class="container hidden">
    <h3 class="mb-3"><i class="fas fa-crown"></i> Organizer Dashboard</h3>
    
    <div class="card">
      <h3 class="form-section-title"><i class="fas fa-plus-circle"></i> Create Tournament</h3>
      
      <div class="input-group">
        <label for="tournamentTitle">üèÜ Tournament Title</label>
        <input id="tournamentTitle" type="text" placeholder="Tournament title"/>
      </div>
      
      <div class="input-group">
        <label for="tournamentType">üéØ Type</label>
        <select id="tournamentType">
          <option value="solo">Solo</option>
          <option value="duo">Duo</option>
          <option value="squad">Squad</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>üéÆ Game Modes</label>
        <div>
          <input type="checkbox" id="modeBattleRoyale" value="battle-royale">
          <label for="modeBattleRoyale">Battle Royale</label>
        </div>
        <div>
          <input type="checkbox" id="modeClashSquad" value="clash-squad">
          <label for="modeClashSquad">Clash Squad</label>
        </div>
        <div>
          <input type="checkbox" id="modeLeonWolf" value="leon-wolf">
          <label for="modeLeonWolf">Lone Wolf</label>
        </div>
      </div>
      
      <div class="input-group">
        <label for="entryFee">üí∞ Entry Fee (BDT)</label>
        <input id="entryFee" type="number" placeholder="Entry fee" min="0"/>
      </div>
      
      <div class="input-group">
        <label for="prizePool">üèÖ Prize Pool (BDT) or description</label>
        <textarea id="prizePool" placeholder="Example: 30 tk per kill, 2 tk bonus..."></textarea>
      </div>
      
      <div class="input-group">
        <label for="maxPlayers">üë• Max Players</label>
        <input id="maxPlayers" type="number" placeholder="Maximum players" min="2"/>
      </div>
      
      <div class="input-group">
        <label for="tournamentRules">üìú Rules</label>
        <textarea id="tournamentRules" placeholder="Tournament rules" rows="3"></textarea>
      </div>
      
      <div class="input-group">
        <label for="tournamentDate">üìÖ Tournament Date</label>
        <input id="tournamentDate" type="datetime-local"/>
      </div>
      
      <div class="input-group">
        <label for="tournamentPoster">üñºÔ∏è Tournament Poster</label>
        <input id="tournamentPoster" type="file" accept="image/*"/>
      </div>
      
      <button id="createTournamentBtn" class="btn btn-organizer w-100"><i class="fas fa-plus"></i> Create Tournament</button>
    </div>
    
    <div class="card">
      <h3 class="form-section-title"><i class="fas fa-trophy"></i> My Created Tournaments</h3>
      <div id="organizerTournamentsList" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading your tournaments...
      </div>
    </div>
  </div>

  <div id="morePage" class="container hidden">
    <h3 class="mb-3"><i class="fas fa-cog"></i> More Options</h3>
    
    <div class="card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="mb-1"><i class="fas fa-download"></i> App Update</h4>
          <p class="mb-0 text-small">Latest version running</p>
        </div>
        <button id="updateBtn" class="btn btn-sm"><i class="fas fa-download"></i> Download</button>
      </div>
      
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="mb-1"><i class="fas fa-shield-alt"></i> Refund Policy</h4>
          <p class="mb-0 text-small">View our refund policy</p>
        </div>
        <button id="refundBtn" class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</button>
      </div>
      
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="mb-1"><i class="fas fa-gift"></i> Refer & Earn</h4>
          <p class="mb-0 text-small">Earn coins by referring friends</p>
        </div>
        <button id="referBtn" class="btn btn-sm btn-success"><i class="fas fa-tag"></i> View Code</button>
      </div>
      
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-1"><i class="fas fa-bullhorn"></i> Announcements</h4>
          <p class="mb-0 text-small">Latest news and updates</p>
        </div>
        <button id="announcementsBtn" class="btn btn-sm btn-warning"><i class="fas fa-eye"></i> View</button>
      </div>
    </div>
    
    <!-- New Social Media Section -->
    <div class="card social-section">
      <h4 class="form-section-title"><i class="fas fa-share-alt"></i> Follow Us</h4>
      
      <a href="https://www.facebook.com/profile.php?id=61579782358444" target="_blank" class="social-button">
        <div class="social-icon"><i class="fab fa-facebook-f"></i></div>
        <div class="social-content">
          <div class="social-title">Facebook Page</div>
          <div class="social-description">Follow our official page for updates</div>
        </div>
        <div class="social-action">Follow</div>
      </a>
      
      <a href="#" class="social-button" id="guildJoinBtn">
        <div class="social-icon"><i class="fas fa-users"></i></div>
        <div class="social-content">
          <div class="social-title">Join Our Guild</div>
          <div class="social-description">Copy our guild ID to join</div>
        </div>
        <div class="social-action">Copy ID</div>
      </a>
    </div>
    
    <!-- Referral Section -->
    <div class="card referral-section">
      <h4 class="form-section-title"><i class="fas fa-gift"></i> Refer & Earn</h4>
      <p>Refer friends and earn 2 BDT for each successful registration!</p>
      
      <div class="referral-code" id="referralCodeDisplay">Loading...</div>
      
      <button class="copy-btn" id="copyReferralBtn">
        <i class="fas fa-copy"></i> Copy Referral Code
      </button>
    </div>
    
    <div class="card">
      <h4 class="form-section-title"><i class="fas fa-headset"></i> Support</h4>
      <p>Having issues? Contact our support team:</p>
      <p><i class="fas fa-envelope"></i> Email: support@ffkingdom.com</p>
      <p><i class="fab fa-facebook"></i> Facebook: /ffkingdom</p>
      <p><i class="fab fa-whatsapp"></i> WhatsApp: +8801767882562</p>
    </div>
    
    <button id="logoutBtn" class="btn btn-danger w-100"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>

  <div class="nav-bottom">
    <button class="nav-btn active" id="navHome">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </button>
    <button class="nav-btn" id="navProfile">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </button>
    <button class="nav-btn" id="navMyTournaments">
      <i class="fas fa-trophy"></i>
      <span>My Tournaments</span>
    </button>
    <button class="nav-btn" id="navOrganizer">
      <i class="fas fa-crown"></i>
      <span>Organizer</span>
    </button>
    <button class="nav-btn" id="navMore">
      <i class="fas fa-ellipsis-h"></i>
      <span>More</span>
    </button>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBg">
  <div class="modal-content" id="modalContent">
    <h3 class="modal-title" id="modalTitle"></h3>
    <div id="modalBody"></div>
    <button class="btn w-100 mt-3" id="modalClose">Close</button>
  </div>
</div>

<!-- User Profile Modal -->
<div class="modal-backdrop" id="userProfileModalBg">
  <div class="modal-content" id="userProfileModalContent">
    <h3 class="modal-title" id="userProfileModalTitle">Player Profile</h3>
    <div id="userProfileModalBody"></div>
    <button class="btn w-100 mt-3" id="userProfileModalClose">Close</button>
  </div>
</div>

<!-- Announcements Modal -->
<div class="modal-backdrop" id="announcementsModalBg">
  <div class="modal-content" id="announcementsModalContent">
    <h3 class="modal-title"><i class="fas fa-bullhorn"></i> Announcements</h3>
    <div id="announcementsList" class="announcement-list">
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading announcements...</div>
    </div>
    <button class="btn w-100 mt-3" id="announcementsModalClose">Close</button>
  </div>
</div>

<!-- Tournament Details Modal -->
<div class="modal-backdrop" id="tournamentDetailsModalBg">
  <div class="modal-content" id="tournamentDetailsModalContent">
    <h3 class="modal-title" id="tournamentDetailsModalTitle">Tournament Details</h3>
    <div id="tournamentDetailsModalBody"></div>
    <button class="btn w-100 mt-3" id="tournamentDetailsModalClose">Close</button>
  </div>
</div>

<!-- Edit Tournament Modal -->
<div class="modal-backdrop" id="editTournamentModalBg">
  <div class="modal-content" id="editTournamentModalContent">
    <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Tournament</h3>
    <div id="editTournamentModalBody" class="edit-tournament-form"></div>
    <button class="btn btn-organizer w-100 mt-3" id="saveTournamentChangesBtn">Save Changes</button>
    <button class="btn w-100 mt-2" id="editTournamentModalClose">Cancel</button>
  </div>
</div>

<!-- Announcement Toast Notification -->
<div class="announcement-toast" id="announcementToast">
  <div class="announcement-toast-icon">
    <i class="fas fa-bullhorn"></i>
  </div>
  <div class="announcement-toast-content">
    <div class="announcement-toast-title" id="toastTitle">New Announcement</div>
    <div class="announcement-toast-message" id="toastMessage">You have a new announcement</div>
  </div>
  <button class="announcement-toast-close" id="toastClose">
    <i class="fas fa-times"></i>
  </button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD1-qeqgWg9-3TW--XnpWQHNTP7-ROhDIs",
  authDomain: "football-manager-cf301.firebaseapp.com",
  databaseURL: "https://football-manager-cf301-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "football-manager-cf301",
  storageBucket: "football-manager-cf301.firebasestorage.app",
  messagingSenderId: "491848692016",
  appId: "1:491848692016:web:dc080692f1c5ee6c5298f5",
  measurementId: "G-FQL2QPVX6P"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const MIN_DEPOSIT = 10, MIN_WITHDRAW = 100;
const IMGBB_API_KEY = '213fd215f712156cc6a6ab529469da2f';
const GUILD_ID = '3059289441';
const REFERRAL_REWARD = 2; // 2 BDT per referral

// Navigation
const pages = {
  homePage: document.getElementById('homePage'),
  profilePage: document.getElementById('profilePage'),
  myTournamentsPage: document.getElementById('myTournamentsPage'),
  organizerPage: document.getElementById('organizerPage'),
  morePage: document.getElementById('morePage')
};

function showPage(pageId) {
  // Hide all pages
  for (let key in pages) {
    pages[key].classList.add('hidden');
  }
  
  // Show the selected page
  pages[pageId].classList.remove('hidden');
  
  // Update active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const pageName = pageId.replace('Page', '');
  document.getElementById('nav' + pageName.charAt(0).toUpperCase() + pageName.slice(1)).classList.add('active');
}

// Set up navigation
document.getElementById('navHome').addEventListener('click', () => showPage('homePage'));
document.getElementById('navProfile').addEventListener('click', () => showPage('profilePage'));
document.getElementById('navMyTournaments').addEventListener('click', () => showPage('myTournamentsPage'));
document.getElementById('navOrganizer').addEventListener('click', () => {
  const user = auth.currentUser;
  if (user) {
    db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
      const isOrganizer = snapshot.val();
      if (isOrganizer) {
        showPage('organizerPage');
      } else {
        showModal('Access Denied', 'You are not an organizer. Only verified organizers can access this section.');
      }
    });
  } else {
    showModal('Error', 'You must be logged in to access this section');
  }
});
document.getElementById('navMore').addEventListener('click', () => showPage('morePage'));

// Registration tabs
document.getElementById('loginTabBtn').addEventListener('click', function() {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  this.classList.add('active');
  document.getElementById('loginTab').classList.add('active');
});

document.getElementById('registerTabBtn').addEventListener('click', function() {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  this.classList.add('active');
  document.getElementById('registerTab').classList.add('active');
});

document.getElementById('organizerRegisterTabBtn').addEventListener('click', function() {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  this.classList.add('active');
  document.getElementById('organizerRegisterTab').classList.add('active');
});

// Modal
const modalBg = document.getElementById('modalBg');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
document.getElementById('modalClose').addEventListener('click', () => {
  modalBg.style.display = 'none';
});

function showModal(title, body, isHTML = false) {
  modalTitle.innerText = title;
  if (isHTML) {
    modalBody.innerHTML = body;
  } else {
    modalBody.innerText = body;
  }
  modalBg.style.display = 'flex';
}

// User Profile Modal
const userProfileModalBg = document.getElementById('userProfileModalBg');
const userProfileModalTitle = document.getElementById('userProfileModalTitle');
const userProfileModalBody = document.getElementById('userProfileModalBody');
document.getElementById('userProfileModalClose').addEventListener('click', () => {
  userProfileModalBg.style.display = 'none';
});

function showUserProfileModal(userId) {
  db.ref('users/' + userId).once('value').then(snapshot => {
    const user = snapshot.val() || {};
    
    userProfileModalTitle.innerText = user.name || 'Player Profile';
    
    let profileHTML = `
      <div class="profile-header">
        <img src="${user.profilePic || 'https://via.placeholder.com/80'}" class="profile-pic" alt="Profile"/>
        <div class="profile-info">
          <h2 class="profile-name">${user.name || 'Player'} ${user.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</h2>
          <p>üéÆ Free Fire UID: ${user.freeFireUID || 'Not set'}</p>
          ${user.status ? `<p>üí¨ Status: ${user.status}</p>` : ''}
        </div>
      </div>
      
      <div class="profile-stats">
        <div class="stat-card">
          <div class="stat-value">${user.matchesPlayed || 0}</div>
          <div class="stat-label">üéÆ Matches</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${user.wins || 0}</div>
          <div class="stat-label">üèÜ Wins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${user.winRate ? (user.winRate * 100).toFixed(1) + '%' : '0%'}</div>
          <div class="stat-label">üìä Win Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${user.income || 0}</div>
          <div class="stat-label">üíµ Income</div>
        </div>
      </div>
    `;
    
    userProfileModalBody.innerHTML = profileHTML;
    userProfileModalBg.style.display = 'flex';
  });
}

// Announcements Modal
const announcementsModalBg = document.getElementById('announcementsModalBg');
document.getElementById('announcementsModalClose').addEventListener('click', () => {
  announcementsModalBg.style.display = 'none';
});

// Edit Tournament Modal
const editTournamentModalBg = document.getElementById('editTournamentModalBg');
const editTournamentModalBody = document.getElementById('editTournamentModalBody');
document.getElementById('editTournamentModalClose').addEventListener('click', () => {
  editTournamentModalBg.style.display = 'none';
});

// Announcement Toast
const announcementToast = document.getElementById('announcementToast');
const toastTitle = document.getElementById('toastTitle');
const toastMessage = document.getElementById('toastMessage');
document.getElementById('toastClose').addEventListener('click', () => {
  announcementToast.classList.remove('show');
});

function showAnnouncementToast(title, message) {
  toastTitle.textContent = title;
  toastMessage.textContent = message;
  announcementToast.classList.add('show');
  
  setTimeout(() => {
    announcementToast.classList.remove('show');
  }, 5000);
}

function loadAnnouncements() {
  db.ref('announcements').orderByChild('timestamp').limitToLast(10).once('value').then(snapshot => {
    let announcementsHTML = '';
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const announcement = child.val();
        announcementsHTML += `
          <div class="announcement-item">
            <div class="announcement-title">${announcement.title}</div>
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${new Date(announcement.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      });
    } else {
      announcementsHTML = '<div class="text-center py-3">No announcements yet</div>';
    }
    
    document.getElementById('announcementsList').innerHTML = announcementsHTML;
  });
}

// Load announcements for the slider
function loadAnnouncementsSlider() {
  db.ref('announcements').orderByChild('timestamp').limitToLast(5).once('value').then(snapshot => {
    let announcementsHTML = '';
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const announcement = child.val();
        announcementsHTML += `
          <div class="announcement-slide">
            <i class="fas fa-bullhorn"></i> ${announcement.title}: ${announcement.content}
          </div>
        `;
      });
      
      document.getElementById('announcementsTrack').innerHTML = announcementsHTML;
      document.getElementById('announcementsSlider').classList.remove('hidden');
    } else {
      document.getElementById('announcementsSlider').classList.add('hidden');
    }
  });
}

// Load home page announcement banner
function loadHomeAnnouncement() {
  db.ref('announcements').orderByChild('timestamp').limitToLast(1).once('value').then(snapshot => {
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const announcement = child.val();
        document.getElementById('bannerText').textContent = `${announcement.title}: ${announcement.content}`;
        document.getElementById('homeAnnouncementBanner').classList.remove('hidden');
      });
    }
  });
}

// Close announcement banner
document.getElementById('bannerClose').addEventListener('click', () => {
  document.getElementById('homeAnnouncementBanner').classList.add('hidden');
});

// Listen for new announcements
function listenForAnnouncements() {
  db.ref('announcements').orderByChild('timestamp').limitToLast(1).on('child_added', snapshot => {
    const announcement = snapshot.val();
    // Only show toast if announcement is less than 1 minute old
    if (Date.now() - announcement.timestamp < 60000) {
      showAnnouncementToast(announcement.title, announcement.content);
    }
    
    // Update slider and banner
    loadAnnouncementsSlider();
    loadHomeAnnouncement();
  });
}

// More page buttons
document.getElementById('updateBtn').addEventListener('click', () => {
  window.open('https://yourappdownloadlink.com', '_blank');
});

document.getElementById('refundBtn').addEventListener('click', () => {
  showModal('Refund Policy', 'Refunds are only provided if a tournament is canceled by the organizers. In case of any issues, please contact our support team.');
});

document.getElementById('referBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (user) {
    db.ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val() || {};
      const referralCode = userData.referralCode || 'FFK' + user.uid.substring(0, 8).toUpperCase();
      
      showModal('Refer & Earn', `
        <div class="referral-section">
          <p>Share your referral code with friends and earn ${REFERRAL_REWARD} BDT when they sign up and make their first deposit!</p>
          <div class="referral-code">${referralCode}</div>
          <button class="copy-btn" onclick="copyToClipboard('${referralCode}')">
            <i class="fas fa-copy"></i> Copy Referral Code
          </button>
        </div>
      `, true);
    });
  } else {
    showModal('Error', 'You must be logged in to view your referral code');
  }
});

document.getElementById('announcementsBtn').addEventListener('click', () => {
  loadAnnouncements();
  announcementsModalBg.style.display = 'flex';
});

// Copy guild ID to clipboard
document.getElementById('guildJoinBtn').addEventListener('click', function(e) {
  e.preventDefault();
  copyToClipboard(GUILD_ID);
  showAnnouncementToast('Guild ID Copied', `Guild ID ${GUILD_ID} copied to clipboard!`);
});

// Copy referral code to clipboard
document.getElementById('copyReferralBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (user) {
    db.ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val() || {};
      const referralCode = userData.referralCode || 'FFK' + user.uid.substring(0, 8).toUpperCase();
      copyToClipboard(referralCode);
      showAnnouncementToast('Referral Code Copied', `Referral code ${referralCode} copied to clipboard!`);
    });
  }
});

function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}

// Search functionality
document.getElementById('searchToggleBtn').addEventListener('click', () => {
  const searchContainer = document.getElementById('searchContainer');
  if (searchContainer.classList.contains('hidden')) {
    searchContainer.classList.remove('hidden');
    document.getElementById('userSearchInput').focus();
  } else {
    searchContainer.classList.add('hidden');
    document.getElementById('searchResults').classList.remove('active');
  }
});

document.getElementById('userSearchInput').addEventListener('input', debounce(function(e) {
  const query = e.target.value.trim().toLowerCase();
  const searchResults = document.getElementById('searchResults');
  
  if (query.length < 2) {
    searchResults.classList.remove('active');
    return;
  }
  
  db.ref('users').once('value').then(snapshot => {
    let resultsHTML = '';
    let resultCount = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const user = child.val();
        const userName = user.name || '';
        const userUID = user.freeFireUID || '';
        
        if (userName.toLowerCase().includes(query) || userUID.toLowerCase().includes(query)) {
          resultCount++;
          resultsHTML += `
            <div class="user-search-result" data-userid="${child.key}">
              <img src="${user.profilePic || 'https://via.placeholder.com/50'}" class="user-search-avatar" alt="${userName}">
              <div class="user-search-info">
                <div class="user-search-name">${userName} ${user.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</div>
                <div class="user-search-uid">UID: ${userUID}</div>
              </div>
            </div>
          `;
        }
      });
    }
    
    if (resultCount > 0) {
      searchResults.innerHTML = resultsHTML;
      searchResults.classList.add('active');
      
      // Add click event to search results
      document.querySelectorAll('.user-search-result').forEach(result => {
        result.addEventListener('click', () => {
          const userId = result.getAttribute('data-userid');
          showUserProfileModal(userId);
          document.getElementById('searchContainer').classList.add('hidden');
          document.getElementById('userSearchInput').value = '';
          searchResults.classList.remove('active');
        });
      });
    } else {
      searchResults.innerHTML = '<div class="text-center py-3">No players found</div>';
      searchResults.classList.add('active');
    }
  });
}, 300));

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Tournament filtering
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    const filter = this.getAttribute('data-filter');
    filterTournaments(filter);
  });
});

function filterTournaments(filter) {
  const tournamentCards = document.querySelectorAll('.tournament-card');
  
  tournamentCards.forEach(card => {
    if (filter === 'all') {
      card.style.display = 'block';
    } else {
      const gameModes = card.getAttribute('data-game-modes') || '';
      if (gameModes.includes(filter)) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    }
  });
}

// Load tournaments
function loadTournaments() {
  db.ref('tournaments').on('value', snap => {
    let html = "";
    if (snap.exists()) {
      snap.forEach(child => {
        let tournament = child.val();
        let image = tournament.image || 'https://via.placeholder.com/400x200?text=Tournament';
        let gameModes = tournament.gameModes || ['solo'];
        let winnerId = tournament.winner || null;
        let tournamentDate = tournament.tournamentDate || Date.now();
        let organizerId = tournament.organizerId;
        
        // Get organizer info
        db.ref('users/' + organizerId).once('value').then(orgSnapshot => {
          const organizer = orgSnapshot.val() || {};
          
          html += `
            <div class="card tournament-card tournament-card-mobile" data-game-modes="${gameModes.join(' ')}">
              <img src="${image}" class="tournament-img-mobile"/>
              <span class="tournament-badge">${tournament.type || 'Solo'}</span>
              ${winnerId ? '<span class="tournament-winner-badge">Winner Declared</span>' : ''}
              <div class="tournament-content-mobile">
                <h3 class="tournament-title">${tournament.title || 'Unnamed Tournament'}</h3>
                <p class="tournament-info"><i class="fas fa-ticket-alt"></i> Entry: ${tournament.entryFee || 0} BDT</p>
                <p class="tournament-info"><i class="fas fa-award"></i> Prize: ${tournament.prizePool || 0}</p>
                <p class="tournament-info"><i class="fas fa-users"></i> Players: ${tournament.players ? Object.keys(tournament.players).length : 0}/${tournament.maxPlayers || 50}</p>
                <p class="tournament-date"><i class="fas fa-calendar"></i> ${new Date(tournamentDate).toLocaleDateString()} ${new Date(tournamentDate).toLocaleTimeString()}</p>
                
                <div class="organizer-name">
                  <i class="fas fa-crown"></i> Organizer: ${organizer.name || 'Unknown'} 
                  ${organizer.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                </div>
                
                <div class="game-mode-badges">
                  ${gameModes.map(mode => `<span class="game-mode-badge">${modeToLabel(mode)}</span>`).join('')}
                </div>
                
                <div class="tournament-actions">
                  <button class="btn btn-sm btn-info" onclick="showTournamentDetails('${child.key}')"><i class="fas fa-info-circle"></i> Details</button>
                  ${!winnerId ? `<button class="btn btn-sm btn-success" onclick="joinTournament('${child.key}', ${tournament.entryFee || 0})"><i class="fas fa-sign-in-alt"></i> Join</button>` : ''}
                </div>
              </div>
            </div>
          `;
          
          document.getElementById('tournamentsList').innerHTML = html;
        });
      });
    } else {
      html = '<div class="text-center py-4"><i class="fas fa-trophy fa-2x mb-3"></i><p>No tournaments available at the moment</p></div>';
      document.getElementById('tournamentsList').innerHTML = html;
    }
  });
}

function modeToLabel(mode) {
  const modeLabels = {
    'solo': 'Solo',
    'duo': 'Duo',
    'squad': 'Squad',
    'battle-royale': 'Battle Royale',
    'clash-squad': 'Clash Squad',
    'leon-wolf': 'Lone Wolf'
  };
  
  return modeLabels[mode] || mode;
}

// Tournament details
function showTournamentDetails(tournamentId) {
  db.ref('tournaments/' + tournamentId).once('value').then(snapshot => {
    const tournament = snapshot.val();
    if (!tournament) {
      showModal('Error', 'Tournament not found');
      return;
    }
    
    // Get organizer info
    db.ref('users/' + tournament.organizerId).once('value').then(orgSnapshot => {
      const organizer = orgSnapshot.val() || {};
      
      const players = tournament.players ? Object.keys(tournament.players) : [];
      let detailsHTML = `
        <div class="tournament-details">
          <p><strong>Title:</strong> ${tournament.title || 'Unnamed Tournament'}</p>
          <p><strong>Type:</strong> ${tournament.type || 'Solo'}</p>
          <p><strong>Game Modes:</strong> ${(tournament.gameModes || ['solo']).map(modeToLabel).join(', ')}</p>
          <p><strong>Entry Fee:</strong> ${tournament.entryFee || 0} BDT</p>
          <p><strong>Prize Pool:</strong> ${tournament.prizePool || 0}</p>
          <p><strong>Max Players:</strong> ${tournament.maxPlayers || 50}</p>
          <p><strong>Date:</strong> ${new Date(tournament.tournamentDate).toLocaleDateString()} ${new Date(tournament.tournamentDate).toLocaleTimeString()}</p>
          <p><strong>Organizer:</strong> ${organizer.name || 'Unknown'} ${organizer.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</p>
          <p><strong>Rules:</strong> ${tournament.rules || 'No special rules'}</p>
          <p><strong>Players Joined:</strong> ${players.length}</p>
          <hr>
          <p><strong>Player List:</strong></p>
          <div class="player-list">
      `;
      
      if (players.length > 0) {
        // Get player names instead of IDs
        const playerPromises = players.map(playerId => {
          return db.ref('users/' + playerId).once('value')
            .then(userSnapshot => {
              const user = userSnapshot.val() || {};
              return {
                id: playerId,
                name: user.name || 'Unknown Player',
                uid: user.freeFireUID || 'N/A',
                email: user.email || 'N/A'
              };
            });
        });
        
        Promise.all(playerPromises).then(players => {
          players.forEach((player, index) => {
            detailsHTML += `
              <div class="player-item">
                <div>
                  <div class="player-name">${index + 1}. ${player.name}</div>
                  <div class="player-uid">UID: ${player.uid} | Email: ${player.email}</div>
                </div>
                <span class="currency-badge">Joined</span>
              </div>
            `;
          });
          
          // Add organizer controls if user is the organizer
          const user = auth.currentUser;
          if (user && tournament.organizerId === user.uid) {
            detailsHTML += `
              </div>
              <div class="organizer-section">
                <h4><i class="fas fa-crown"></i> Organizer Controls</h4>
                <div class="winner-selection">
                  <p><strong>Select Winner:</strong></p>
                  <select id="winnerSelect" class="form-control">
                    <option value="">Select a winner</option>
                    ${players.map(player => `<option value="${player.id}">${player.name}</option>`).join('')}
                  </select>
                  <button class="btn btn-organizer btn-sm mt-2" onclick="declareWinner('${tournamentId}')">Declare Winner</button>
                </div>
                <div class="mt-3">
                  <button class="btn btn-warning btn-sm" onclick="editTournament('${tournamentId}')"><i class="fas fa-edit"></i> Edit Tournament</button>
                  <button class="btn btn-danger btn-sm" onclick="cancelTournament('${tournamentId}')"><i class="fas fa-times"></i> Cancel Tournament</button>
                </div>
              </div>
            `;
          }
          
          detailsHTML += `</div></div>`;
          showModal('Tournament Details', detailsHTML, true);
        });
      } else {
        detailsHTML += `<div class="text-center py-3">No players joined yet</div></div></div>`;
        showModal('Tournament Details', detailsHTML, true);
      }
    });
  });
}

// Declare tournament winner
function declareWinner(tournamentId) {
  const winnerSelect = document.getElementById('winnerSelect');
  const winnerId = winnerSelect.value;
  
  if (!winnerId) {
    showModal('Error', 'Please select a winner');
    return;
  }
  
  db.ref('tournaments/' + tournamentId).update({
    winner: winnerId,
    winnerDeclaredAt: Date.now()
  }).then(() => {
    showModal('Success', 'Winner declared successfully!');
    modalBg.style.display = 'none';
  }).catch(error => {
    showModal('Error', error.message);
  });
}

// Edit tournament
function editTournament(tournamentId) {
  db.ref('tournaments/' + tournamentId).once('value').then(snapshot => {
    const tournament = snapshot.val();
    if (!tournament) {
      showModal('Error', 'Tournament not found');
      return;
    }
    
    let editHTML = `
      <div class="input-group">
        <label for="editTournamentTitle">üèÜ Tournament Title</label>
        <input id="editTournamentTitle" type="text" value="${tournament.title || ''}" placeholder="Tournament title"/>
      </div>
      
      <div class="input-group">
        <label for="editTournamentType">üéØ Type</label>
        <select id="editTournamentType">
          <option value="solo" ${tournament.type === 'solo' ? 'selected' : ''}>Solo</option>
          <option value="duo" ${tournament.type === 'duo' ? 'selected' : ''}>Duo</option>
          <option value="squad" ${tournament.type === 'squad' ? 'selected' : ''}>Squad</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>üéÆ Game Modes</label>
        <div>
          <input type="checkbox" id="editModeBattleRoyale" value="battle-royale" ${tournament.gameModes && tournament.gameModes.includes('battle-royale') ? 'checked' : ''}>
          <label for="editModeBattleRoyale">Battle Royale</label>
        </div>
        <div>
          <input type="checkbox" id="editModeClashSquad" value="clash-squad" ${tournament.gameModes && tournament.gameModes.includes('clash-squad') ? 'checked' : ''}>
          <label for="editModeClashSquad">Clash Squad</label>
        </div>
        <div>
          <input type="checkbox" id="editModeLeonWolf" value="leon-wolf" ${tournament.gameModes && tournament.gameModes.includes('leon-wolf') ? 'checked' : ''}>
          <label for="editModeLeonWolf">Lone Wolf</label>
        </div>
      </div>
      
      <div class="input-group">
        <label for="editEntryFee">üí∞ Entry Fee (BDT)</label>
        <input id="editEntryFee" type="number" value="${tournament.entryFee || 0}" placeholder="Entry fee" min="0"/>
      </div>
      
      <div class="input-group">
        <label for="editPrizePool">üèÖ Prize Pool (BDT) or description</label>
        <textarea id="editPrizePool" placeholder="Example: 30 tk per kill, 2 tk bonus...">${tournament.prizePool || ''}</textarea>
      </div>
      
      <div class="input-group">
        <label for="editMaxPlayers">üë• Max Players</label>
        <input id="editMaxPlayers" type="number" value="${tournament.maxPlayers || 50}" placeholder="Maximum players" min="2"/>
      </div>
      
      <div class="input-group">
        <label for="editTournamentRules">üìú Rules</label>
        <textarea id="editTournamentRules" placeholder="Tournament rules" rows="3">${tournament.rules || ''}</textarea>
      </div>
      
      <div class="input-group">
        <label for="editTournamentDate">üìÖ Tournament Date</label>
        <input id="editTournamentDate" type="datetime-local" value="${new Date(tournament.tournamentDate).toISOString().slice(0, 16)}"/>
      </div>
    `;
    
    editTournamentModalBody.innerHTML = editHTML;
    editTournamentModalBg.style.display = 'flex';
    
    // Save changes button
    document.getElementById('saveTournamentChangesBtn').onclick = function() {
      saveTournamentChanges(tournamentId);
    };
  });
}

// Save tournament changes
function saveTournamentChanges(tournamentId) {
  const title = document.getElementById('editTournamentTitle').value;
  const type = document.getElementById('editTournamentType').value;
  const entryFee = parseInt(document.getElementById('editEntryFee').value) || 0;
  const prizePool = document.getElementById('editPrizePool').value;
  const maxPlayers = parseInt(document.getElementById('editMaxPlayers').value) || 50;
  const rules = document.getElementById('editTournamentRules').value;
  const tournamentDate = document.getElementById('editTournamentDate').value;
  
  if (!title || !type || !prizePool || !maxPlayers || !tournamentDate) {
    showModal('Error', 'Please fill all required fields');
    return;
  }
  
  // Get selected game modes
  const gameModes = [];
  if (document.getElementById('editModeBattleRoyale').checked) gameModes.push('battle-royale');
  if (document.getElementById('editModeClashSquad').checked) gameModes.push('clash-squad');
  if (document.getElementById('editModeLeonWolf').checked) gameModes.push('leon-wolf');
  
  if (gameModes.length === 0) {
    showModal('Error', 'Please select at least one game mode');
    return;
  }
  
  const updates = {
    title: title,
    type: type,
    gameModes: gameModes,
    entryFee: entryFee,
    prizePool: prizePool,
    maxPlayers: maxPlayers,
    rules: rules,
    tournamentDate: new Date(tournamentDate).getTime(),
    updatedAt: Date.now()
  };
  
  db.ref('tournaments/' + tournamentId).update(updates)
    .then(() => {
      showModal('Success', 'Tournament updated successfully!');
      editTournamentModalBg.style.display = 'none';
    })
    .catch(error => {
      showModal('Error', error.message);
    });
}

// Cancel tournament and refund players
function cancelTournament(tournamentId) {
  if (!confirm("Are you sure you want to cancel this tournament? All entry fees will be refunded to players.")) {
    return;
  }
  
  db.ref('tournaments/' + tournamentId).once('value').then(snapshot => {
    const tournament = snapshot.val();
    if (!tournament) return;
    
    const entryFee = tournament.entryFee || 0;
    const players = tournament.players ? Object.keys(tournament.players) : [];
    
    // Refund each player
    const refundPromises = players.map(playerId => {
      return db.ref('users/' + playerId + '/coins').once('value').then(coinSnapshot => {
        const currentCoins = coinSnapshot.val() || 0;
        return db.ref('users/' + playerId + '/coins').set(currentCoins + entryFee);
      }).then(() => {
        // Record transaction
        return db.ref('transactions/' + playerId).push({
          type: 'tournament_refund',
          amount: entryFee,
          tournamentId: tournamentId,
          tournamentName: tournament.title,
          status: 'approved',
          timestamp: Date.now()
        });
      });
    });
    
    Promise.all(refundPromises).then(() => {
      // Delete tournament
      return db.ref('tournaments/' + tournamentId).remove();
    }).then(() => {
      showModal('Success', 'Tournament canceled and all players refunded successfully!');
      modalBg.style.display = 'none';
    }).catch(error => {
      showModal('Error', error.message);
    });
  });
}

// Check if user is banned before allowing actions
function checkIfBanned(userId) {
  return db.ref('bannedUsers/' + userId).once('value').then(snapshot => {
    return snapshot.exists();
  });
}

// Join tournament with ban check
function joinTournament(tournamentId, entryFee) {
  const user = auth.currentUser;
  if (!user) {
    showModal('Error', 'You must be logged in to join a tournament');
    return;
  }
  
  // Check if user is an organizer
  db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
    const isOrganizer = snapshot.val();
    if (isOrganizer) {
      showModal('Error', 'Organizers cannot join tournaments as players');
      return;
    }
    
    checkIfBanned(user.uid).then(isBanned => {
      if (isBanned) {
        showModal('Account Banned', 'Your account has been banned. You cannot join tournaments. Please contact support for more information.');
        return;
      }
      
      db.ref('users/' + user.uid + '/coins').once('value').then(snapshot => {
        const coins = snapshot.val() || 0;
        
        if (coins >= entryFee) {
          // Get user details for the tournament registration
          db.ref('users/' + user.uid).once('value').then(userSnapshot => {
            const userData = userSnapshot.val() || {};
            
            // Deduct entry fee
            db.ref('users/' + user.uid + '/coins').set(coins - entryFee);
            
            // Add user to tournament with details
            db.ref('tournaments/' + tournamentId + '/players/' + user.uid).set({
              name: userData.name || 'Unknown Player',
              uid: userData.freeFireUID || 'N/A',
              email: userData.email || 'N/A',
              joinedAt: Date.now()
            });
            
            // Add tournament to user's list
            db.ref('userTournaments/' + user.uid + '/' + tournamentId).set({
              joinedAt: Date.now(),
              status: 'registered',
              tournamentName: document.getElementById('tournamentsList').querySelector(`[onclick*="${tournamentId}"]`).closest('.tournament-card').querySelector('.tournament-title').textContent
            });
            
            showModal('Success', 'You have successfully joined the tournament!');
          });
        } else {
          showModal('Error', 'You do not have enough coins to join this tournament');
        }
      });
    });
  });
}

// Load user profile with ban status
function loadProfile(userId) {
  db.ref('users/' + userId).on('value', snapshot => {
    const user = snapshot.val() || {};
    
    // Update profile page
    document.getElementById('profileName').textContent = user.name || 'Player';
    document.getElementById('walletBalance').textContent = user.coins || 0;
    
    // Show different stats based on user type
    if (user.isOrganizer) {
      document.getElementById('playerStats').classList.add('hidden');
      document.getElementById('organizerStats').classList.remove('hidden');
      document.getElementById('playerWalletSection').classList.add('hidden');
      
      // Load organizer stats
      loadOrganizerStats(userId);
    } else {
      document.getElementById('playerStats').classList.remove('hidden');
      document.getElementById('organizerStats').classList.add('hidden');
      document.getElementById('playerWalletSection').classList.remove('hidden');
      
      document.getElementById('profileMatches').textContent = user.matchesPlayed || 0;
      document.getElementById('profileWins').textContent = user.wins || 0;
      document.getElementById('profileIncome').textContent = user.income || 0;
    }
    
    if (user.freeFireUID) {
      document.querySelector('#profileFFUID span').textContent = user.freeFireUID;
    }
    
    if (user.profilePic) {
      document.getElementById('profilePic').src = user.profilePic;
    }
    
    if (user.status) {
      document.getElementById('profileStatusDisplay').textContent = 'üí¨ Status: ' + user.status;
    }
    
    // Show verified badge if user is verified
    if (user.isVerified) {
      document.getElementById('profileName').innerHTML = (user.name || 'Player') + ' <i class="fas fa-check-circle verified-badge"></i>';
    }
    
    // Pre-fill edit form
    document.getElementById('editName').value = user.name || '';
    document.getElementById('editFFUID').value = user.freeFireUID || '';
    document.getElementById('profileStatus').value = user.status || '';
    
    // Load referral code
    if (user.referralCode) {
      document.getElementById('referralCodeDisplay').textContent = user.referralCode;
    } else {
      // Generate referral code if not exists
      const referralCode = 'FFK' + userId.substring(0, 8).toUpperCase();
      db.ref('users/' + userId + '/referralCode').set(referralCode);
      document.getElementById('referralCodeDisplay').textContent = referralCode;
    }
    
    // Check if user is banned and show warning
    checkIfBanned(userId).then(isBanned => {
      if (isBanned) {
        const profileCard = document.querySelector('#profilePage .card');
        if (!profileCard.querySelector('.banned-overlay')) {
          const bannedOverlay = document.createElement('div');
          bannedOverlay.className = 'banned-overlay';
          bannedOverlay.innerHTML = `
            <div class="banned-icon"><i class="fas fa-ban"></i></div>
            <h3>Account Banned</h3>
            <p>Your account has been suspended. You cannot join tournaments or withdraw funds.</p>
            <p>Please contact support for more information.</p>
          `;
          profileCard.style.position = 'relative';
          profileCard.appendChild(bannedOverlay);
        }
      }
    });
  });
}

// Load organizer stats
function loadOrganizerStats(userId) {
  // Count tournaments hosted
  db.ref('tournaments').orderByChild('organizerId').equalTo(userId).once('value').then(snapshot => {
    const tournamentsHosted = snapshot.numChildren();
    document.getElementById('tournamentsHosted').textContent = tournamentsHosted;
    
    // Count completed tournaments
    let completed = 0;
    let totalParticipants = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const tournament = child.val();
        if (tournament.winner) {
          completed++;
        }
        if (tournament.players) {
          totalParticipants += Object.keys(tournament.players).length;
        }
      });
    }
    
    document.getElementById('tournamentsCompleted').textContent = completed;
    document.getElementById('totalParticipants').textContent = totalParticipants;
  });
  
  // Calculate organizer income (from entry fees)
  db.ref('transactions').orderByChild('userId').equalTo(userId).once('value').then(snapshot => {
    let income = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const transaction = child.val();
        if (transaction.type === 'tournament_income') {
          income += transaction.amount || 0;
        }
      });
    }
    
    document.getElementById('organizerIncome').textContent = income;
  });
}

// Load transactions
function loadTransactions(userId) {
  db.ref('transactions/' + userId).on('value', snapshot => {
    let transactionsHTML = '';
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const transaction = child.val();
        transactionsHTML += `
          <div class="transaction-item">
            <div>
              <div>${transaction.type} - ${transaction.amount} BDT</div>
              <small>${new Date(transaction.timestamp).toLocaleDateString()}</small>
            </div>
            <span class="status-${transaction.status}">${transaction.status}</span>
          </div>
        `;
      });
    } else {
      transactionsHTML = '<div class="text-center py-3">No transactions found</div>';
    }
    
    document.getElementById('transactionsList').innerHTML = transactionsHTML;
  });
}

// Load user's tournaments
function loadMyTournaments(userId) {
  db.ref('userTournaments/' + userId).on('value', snapshot => {
    let tournamentsHTML = '';
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const tournamentId = child.key;
        const tournamentData = child.val();
        
        // Get tournament details
        db.ref('tournaments/' + tournamentId).once('value').then(tournamentSnapshot => {
          const tournament = tournamentSnapshot.val();
          
          if (tournament) {
            tournamentsHTML += `
              <div class="card tournament-card">
                <div class="tournament-content">
                  <h3 class="tournament-title">${tournament.title || 'Unnamed Tournament'}</h3>
                  <p class="tournament-info"><i class="fas fa-flag"></i> Type: ${tournament.type || 'Solo'}</p>
                  <p class="tournament-info"><i class="fas fa-ticket-alt"></i> Entry: ${tournament.entryFee || 0} BDT</p>
                  <p class="tournament-info"><i class="fas fa-award"></i> Prize: ${tournament.prizePool || 0}</p>
                  <p class="tournament-info"><i class="fas fa-users"></i> Players: ${tournament.players ? Object.keys(tournament.players).length : 0}/${tournament.maxPlayers || 50}</p>
                  <p class="tournament-info"><i class="fas fa-info-circle"></i> Status: ${tournamentData.status || 'registered'}</p>
                </div>
              </div>
            `;
            
            document.getElementById('myTournamentsList').innerHTML = tournamentsHTML;
          }
        });
      });
    } else {
      tournamentsHTML = '<div class="text-center py-4"><i class="fas fa-trophy fa-2x mb-3"></i><p>You haven\'t joined any tournaments yet</p></div>';
      document.getElementById('myTournamentsList').innerHTML = tournamentsHTML;
    }
  });
}

// Load organizer's tournaments
function loadOrganizerTournaments(userId) {
  db.ref('tournaments').orderByChild('organizerId').equalTo(userId).on('value', snapshot => {
    let tournamentsHTML = '';
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const tournament = child.val();
        const players = tournament.players ? Object.keys(tournament.players) : [];
        
        tournamentsHTML += `
          <div class="card organizer-tournament-card">
            <div class="tournament-content">
              <h3 class="tournament-title">${tournament.title || 'Unnamed Tournament'}</h3>
              <p class="tournament-info"><i class="fas fa-flag"></i> Type: ${tournament.type || 'Solo'}</p>
              <p class="tournament-info"><i class="fas fa-ticket-alt"></i> Entry: ${tournament.entryFee || 0} BDT</p>
              <p class="tournament-info"><i class="fas fa-award"></i> Prize: ${tournament.prizePool || 0}</p>
              <p class="tournament-info"><i class="fas fa-users"></i> Players: ${players.length}/${tournament.maxPlayers || 50}</p>
              <p class="tournament-date"><i class="fas fa-calendar"></i> ${new Date(tournament.tournamentDate).toLocaleDateString()} ${new Date(tournament.tournamentDate).toLocaleTimeString()}</p>
              
              <div class="organizer-controls">
                <button class="btn btn-sm btn-info" onclick="showTournamentDetails('${child.key}')">
                  <i class="fas fa-info-circle"></i> Details
                </button>
                ${!tournament.winner ? `
                <button class="btn btn-sm btn-warning" onclick="editTournament('${child.key}')">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger" onclick="cancelTournament('${child.key}')">
                  <i class="fas fa-times"></i> Cancel
                </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      });
    } else {
      tournamentsHTML = '<div class="text-center py-4"><i class="fas fa-trophy fa-2x mb-3"></i><p>You haven\'t created any tournaments yet</p></div>';
    }
    
    document.getElementById('organizerTournamentsList').innerHTML = tournamentsHTML;
  });
}

// Create tournament
document.getElementById('createTournamentBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (!user) return;
  
  // Check if user is an organizer
  db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
    const isOrganizer = snapshot.val();
    if (!isOrganizer) {
      showModal('Error', 'Only organizers can create tournaments');
      return;
    }
    
    const title = document.getElementById('tournamentTitle').value;
    const type = document.getElementById('tournamentType').value;
    const entryFee = parseInt(document.getElementById('entryFee').value) || 0;
    const prizePool = document.getElementById('prizePool').value;
    const maxPlayers = parseInt(document.getElementById('maxPlayers').value) || 50;
    const rules = document.getElementById('tournamentRules').value;
    const tournamentDate = document.getElementById('tournamentDate').value;
    const file = document.getElementById('tournamentPoster').files[0];
    
    if (!title || !type || !prizePool || !maxPlayers || !tournamentDate) {
      showModal('Error', 'Please fill all required fields');
      return;
    }
    
    // Get selected game modes
    const gameModes = [];
    if (document.getElementById('modeBattleRoyale').checked) gameModes.push('battle-royale');
    if (document.getElementById('modeClashSquad').checked) gameModes.push('clash-squad');
    if (document.getElementById('modeLeonWolf').checked) gameModes.push('leon-wolf');
    
    if (gameModes.length === 0) {
      showModal('Error', 'Please select at least one game mode');
      return;
    }
    
    // If poster is uploaded, upload to ImgBB
    if (file) {
      const formData = new FormData();
      formData.append('image', file);
      formData.append('key', IMGBB_API_KEY);
      
      fetch('https://api.imgbb.com/1/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          createTournamentInDB(data.data.url);
        } else {
          throw new Error('Image upload failed');
        }
      })
      .catch(error => {
        showModal('Error', error.message);
      });
    } else {
      createTournamentInDB('');
    }
    
    function createTournamentInDB(imageUrl) {
      const tournamentData = {
        title: title,
        type: type,
        gameModes: gameModes,
        entryFee: entryFee,
        prizePool: prizePool,
        maxPlayers: maxPlayers,
        rules: rules,
        tournamentDate: new Date(tournamentDate).getTime(),
        image: imageUrl,
        organizerId: user.uid,
        createdAt: Date.now(),
        endTime: new Date(tournamentDate).getTime() + (24 * 60 * 60 * 1000) // 24 hours after start
      };
      
      db.ref('tournaments').push(tournamentData)
        .then(() => {
          showModal('Success', 'Tournament created successfully!');
          // Clear form
          document.getElementById('tournamentTitle').value = '';
          document.getElementById('entryFee').value = '';
          document.getElementById('prizePool').value = '';
          document.getElementById('maxPlayers').value = '';
          document.getElementById('tournamentRules').value = '';
          document.getElementById('tournamentDate').value = '';
          document.getElementById('tournamentPoster').value = '';
          document.getElementById('modeBattleRoyale').checked = false;
          document.getElementById('modeClashSquad').checked = false;
          document.getElementById('modeLeonWolf').checked = false;
        })
        .catch(error => {
          showModal('Error', error.message);
        });
    }
  });
});

// Update profile
document.getElementById('updateProfileBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (!user) return;
  
  const name = document.getElementById('editName').value;
  const freeFireUID = document.getElementById('editFFUID').value;
  const status = document.getElementById('profileStatus').value;
  
  const updates = {};
  if (name) updates.name = name;
  if (freeFireUID) updates.freeFireUID = freeFireUID;
  if (status) updates.status = status;
  
  db.ref('users/' + user.uid).update(updates)
    .then(() => {
      showModal('Success', 'Profile updated successfully');
      document.getElementById('profileStatusDisplay').textContent = 'üí¨ Status: ' + status;
    })
    .catch(error => showModal('Error', error.message));
});

// Emoji selection
document.querySelectorAll('.emoji-option').forEach(emoji => {
  emoji.addEventListener('click', () => {
    document.getElementById('profileStatus').value += emoji.textContent;
  });
});

// Upload profile picture to ImgBB
document.getElementById('uploadPicBtn').addEventListener('click', () => {
  const fileInput = document.getElementById('profilePicFile');
  const file = fileInput.files[0];
  
  if (!file) {
    showModal('Error', 'Please select an image file');
    return;
  }
  
  const user = auth.currentUser;
  if (!user) return;
  
  // Show uploading state
  const uploadBtn = document.getElementById('uploadPicBtn');
  const originalText = uploadBtn.innerHTML;
  uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
  uploadBtn.classList.add('uploading');
  
  // Create form data
  const formData = new FormData();
  formData.append('image', file);
  formData.append('key', IMGBB_API_KEY);
  
  // Upload to ImgBB
  fetch('https://api.imgbb.com/1/upload', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Save the image URL to user profile
      return db.ref('users/' + user.uid).update({
        profilePic: data.data.url
      });
    } else {
      throw new Error('Image upload failed');
    }
  })
  .then(() => {
    showModal('Success', 'Profile picture updated successfully');
    document.getElementById('profilePic').src = URL.createObjectURL(file);
    uploadBtn.innerHTML = originalText;
    uploadBtn.classList.remove('uploading');
  })
  .catch(error => {
    showModal('Error', error.message);
    uploadBtn.innerHTML = originalText;
    uploadBtn.classList.remove('uploading');
  });
});

// Deposit with ban check - FIXED: Add type field to distinguish deposit/withdraw
document.getElementById('depositBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (!user) return;
  
  // Check if user is an organizer
  db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
    const isOrganizer = snapshot.val();
    if (isOrganizer) {
      showModal('Error', 'Organizers cannot make deposits');
      return;
    }
    
    checkIfBanned(user.uid).then(isBanned => {
      if (isBanned) {
        showModal('Account Banned', 'Your account has been banned. You cannot make deposits. Please contact support for more information.');
        return;
      }
      
      const amount = parseInt(document.getElementById('depositAmount').value);
      const transactionId = document.getElementById('depositTransactionId').value.trim();
      const method = document.getElementById('depositMethod').value;
      
      if (amount < MIN_DEPOSIT) {
        showModal('Error', `Minimum deposit is ${MIN_DEPOSIT} BDT`);
        return;
      }
      
      if (!transactionId) {
        showModal('Error', 'Please enter a transaction ID');
        return;
      }
      
      // Get user details for the payment request
      db.ref('users/' + user.uid).once('value').then(userSnapshot => {
        const userData = userSnapshot.val() || {};
        
        // Save deposit request with user details - FIXED: Add type field
        db.ref('paymentRequests').push({
          userId: user.uid,
          userName: userData.name || 'Unknown',
          userEmail: userData.email || 'N/A',
          userUID: userData.freeFireUID || 'N/A',
          amount: amount,
          method: method,
          transactionId: transactionId,
          type: 'deposit', // This distinguishes deposit from withdraw
          status: 'pending',
          timestamp: Date.now()
        })
        .then(() => {
          showModal('Success', 'Deposit request submitted. It will be processed within 24 hours.');
          document.getElementById('depositAmount').value = '';
          document.getElementById('depositTransactionId').value = '';
        })
        .catch(error => showModal('Error', error.message));
      });
    });
  });
});

// Withdraw with ban check - FIXED: Add type field to distinguish deposit/withdraw
document.getElementById('withdrawBtn').addEventListener('click', () => {
  const user = auth.currentUser;
  if (!user) return;
  
  // Check if user is an organizer
  db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
    const isOrganizer = snapshot.val();
    if (isOrganizer) {
      showModal('Error', 'Organizers cannot withdraw funds');
      return;
    }
    
    checkIfBanned(user.uid).then(isBanned => {
      if (isBanned) {
        showModal('Account Banned', 'Your account has been banned. You cannot withdraw funds. Please contact support for more information.');
        return;
      }
      
      const amount = parseInt(document.getElementById('withdrawAmount').value);
      const account = document.getElementById('withdrawAccount').value.trim();
      const method = document.getElementById('withdrawMethod').value;
      
      if (amount < MIN_WITHDRAW) {
        showModal('Error', `Minimum withdrawal is ${MIN_WITHDRAW} BDT`);
        return;
      }
      
      if (!account) {
        showModal('Error', 'Please enter your account number');
        return;
      }
      
      // Check if user has enough balance
      db.ref('users/' + user.uid + '/coins').once('value').then(snapshot => {
        const coins = snapshot.val() || 0;
        
        if (coins < amount) {
          showModal('Error', 'You do not have enough coins to withdraw');
          return;
        }
        
        // Get user details for the payment request
        db.ref('users/' + user.uid).once('value').then(userSnapshot => {
          const userData = userSnapshot.val() || {};
          
          // Save withdrawal request with user details - FIXED: Add type field
          db.ref('paymentRequests').push({
            userId: user.uid,
            userName: userData.name || 'Unknown',
            userEmail: userData.email || 'N/A',
            userUID: userData.freeFireUID || 'N/A',
            amount: amount,
            method: method,
            account: account,
            type: 'withdraw', // This distinguishes withdraw from deposit
            status: 'pending',
            timestamp: Date.now()
          })
          .then(() => {
            showModal('Success', 'Withdrawal request submitted. It will be processed within 24 hours.');
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawAccount').value = '';
          })
          .catch(error => showModal('Error', error.message));
        });
      });
    });
  });
});

// Organizer registration
document.getElementById('orgSignUpBtn').addEventListener('click', () => {
  const name = document.getElementById('orgRegName').value;
  const email = document.getElementById('orgRegEmail').value;
  const password = document.getElementById('orgRegPassword').value;
  const confirmPassword = document.getElementById('orgRegConfirmPassword').value;
  
  if (!name || !email || !password || !confirmPassword) {
    showModal('Error', 'Please fill all fields');
    return;
  }
  
  if (password !== confirmPassword) {
    showModal('Error', 'Passwords do not match');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {
      const user = userCredential.user;
      
      // Save organizer data
      return db.ref('users/' + user.uid).set({
        name: name,
        email: email,
        isOrganizer: true,
        isVerified: false, // Admin needs to verify organizers
        createdAt: Date.now()
      });
    })
    .then(() => {
      showModal('Success', 'Organizer account created successfully! It will be verified by admin shortly.');
      // Switch to login tab
      document.getElementById('loginTabBtn').click();
    })
    .catch(error => {
      showModal('Error', error.message);
    });
});

// Player registration with referral system
document.getElementById('signUpBtn').addEventListener('click', () => {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const mobile = document.getElementById('regMobile').value;
  const freeFireUID = document.getElementById('regFFUID').value;
  const password = document.getElementById('regPassword').value;
  const confirmPassword = document.getElementById('regConfirmPassword').value;
  const referralCode = new URLSearchParams(window.location.search).get('ref');
  
  if (!name || !email || !mobile || !freeFireUID || !password || !confirmPassword) {
    showModal('Error', 'Please fill all fields');
    return;
  }
  
  if (password !== confirmPassword) {
    showModal('Error', 'Passwords do not match');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {
      const user = userCredential.user;
      
      // Generate referral code for new user
      const userReferralCode = 'FFK' + user.uid.substring(0, 8).toUpperCase();
      
      // Save user data
      return db.ref('users/' + user.uid).set({
        name: name,
        email: email,
        mobile: mobile,
        freeFireUID: freeFireUID,
        coins: 0,
        matchesPlayed: 0,
        wins: 0,
        income: 0,
        referralCode: userReferralCode,
        isOrganizer: false,
        joinedAt: Date.now()
      }).then(() => {
        // Process referral if exists
        if (referralCode) {
          return processReferral(referralCode, user.uid);
        }
      });
    })
    .then(() => {
      showModal('Success', 'Account created successfully!');
      // Switch to login tab
      document.getElementById('loginTabBtn').click();
    })
    .catch(error => {
      showModal('Error', error.message);
    });
});

// Process referral code
function processReferral(referralCode, newUserId) {
  // Find user with this referral code
  return db.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value').then(snapshot => {
    if (snapshot.exists()) {
      let referrerId = null;
      snapshot.forEach(child => {
        referrerId = child.key;
      });
      
      if (referrerId) {
        // Add reward to referrer
        return db.ref('users/' + referrerId + '/coins').once('value').then(coinSnapshot => {
          const currentCoins = coinSnapshot.val() || 0;
          return db.ref('users/' + referrerId + '/coins').set(currentCoins + REFERRAL_REWARD);
        }).then(() => {
          // Record referral transaction
          return db.ref('transactions/' + referrerId).push({
            type: 'referral_reward',
            amount: REFERRAL_REWARD,
            referredUser: newUserId,
            status: 'approved',
            timestamp: Date.now()
          });
        }).then(() => {
          // Record referral for new user
          return db.ref('users/' + newUserId + '/referredBy').set(referrerId);
        });
      }
    }
  });
}

// Login
document.getElementById('loginBtn').addEventListener('click', () => {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showModal('Error', 'Please enter email and password');
    return;
  }
  
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      const user = userCredential.user;
      
      // Hide auth page, show app
      document.getElementById('authPage').classList.add('hidden');
      document.getElementById('appPages').classList.remove('hidden');
      
      // Load user data
      loadProfile(user.uid);
      loadTournaments();
      loadTransactions(user.uid);
      loadMyTournaments(user.uid);
      
      // Check if user is organizer and load organizer tournaments
      db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
        const isOrganizer = snapshot.val();
        if (isOrganizer) {
          loadOrganizerTournaments(user.uid);
          document.getElementById('navOrganizer').classList.remove('hidden');
          // Hide deposit section for organizers
          document.getElementById('depositBtn').closest('.wallet-section').style.display = 'none';
        } else {
          document.getElementById('navOrganizer').classList.add('hidden');
          // Show deposit section for players
          document.getElementById('depositBtn').closest('.wallet-section').style.display = 'block';
        }
      });
    })
    .catch(error => {
      showModal('Error', error.message);
    });
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  auth.signOut()
    .then(() => {
      document.getElementById('authPage').classList.remove('hidden');
      document.getElementById('appPages').classList.add('hidden');
    })
    .catch(error => {
      showModal('Error', error.message);
    });
});

// Check if user is already logged in
auth.onAuthStateChanged(user => {
  if (user) {
    // User is signed in
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('appPages').classList.remove('hidden');
    
    // Load user data
    loadProfile(user.uid);
    loadTournaments();
    loadTransactions(user.uid);
    loadMyTournaments(user.uid);
    
    // Check if user is organizer and load organizer tournaments
    db.ref('users/' + user.uid + '/isOrganizer').once('value').then(snapshot => {
      const isOrganizer = snapshot.val();
      if (isOrganizer) {
        loadOrganizerTournaments(user.uid);
        document.getElementById('navOrganizer').classList.remove('hidden');
        // Hide deposit section for organizers
        document.getElementById('depositBtn').closest('.wallet-section').style.display = 'none';
      } else {
        document.getElementById('navOrganizer').classList.add('hidden');
        // Show deposit section for players
        document.getElementById('depositBtn').closest('.wallet-section').style.display = 'block';
      }
    });
    
    // Start listening for announcements
    listenForAnnouncements();
    loadAnnouncementsSlider();
    loadHomeAnnouncement();
  } else {
    // User is signed out
    document.getElementById('authPage').classList.remove('hidden');
    document.getElementById('appPages').classList.add('hidden');
  }
});
</script>
</body>
</html>
